<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ€æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        wolf: '#BB2D3B',
                        villager: '#198754',
                        night: '#0F172A',
                        day: '#F8FAFC'
                    }
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .role-card {
            perspective: 1000px;
            height: 140px;
            width: 100px;
        }
        .role-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .role-card.flipped .role-card-inner {
            transform: rotateY(180deg);
        }
        .role-card-front, .role-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 0.5rem;
        }
        .role-card-back {
            transform: rotateY(180deg);
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        /* å¤œæ™šæ»¤é•œ */
        .night-filter {
            background-color: rgba(15, 23, 42, 0.5);
            backdrop-filter: brightness(0.7) saturate(0.8);
        }
        
        /* é»‘æš—æ¨¡å¼æ”¯æŒ */
        .dark .bg-white {
            background-color: #181818;
        }
        .dark .bg-gray-100 {
            background-color: #1e1e1e;
        }
        .dark .text-gray-700 {
            color: #d1d5db;
        }
        .dark .text-gray-800 {
            color: #e5e7eb;
        }
        .dark .text-gray-600 {
            color: #9ca3af;
        }
        .dark .border-gray-200 {
            border-color: #2d2d2d;
        }
        .dark .shadow {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        /* å‘è¨€è½®æ¬¡æŒ‡ç¤ºå™¨ */
        .speaking-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(93, 92, 222, 0); }
            100% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen dark:bg-gray-900 dark:text-white transition-colors duration-200">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- æ¬¢è¿å±å¹• -->
        <div id="welcome-screen" class="fade-in">
            <h1 class="text-3xl font-bold text-center mb-8">ğŸº ç‹¼äººæ€æ¸¸æˆ ğŸŒ™</h1>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">å¼€å§‹æ¸¸æˆ</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-medium mb-3">åˆ›å»ºæˆ¿é—´</h3>
                        <div class="mb-4">
                            <label for="player-name-create" class="block mb-2 text-sm font-medium">ä½ çš„åå­—</label>
                            <input type="text" id="player-name-create" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" placeholder="è¾“å…¥ä½ çš„åå­—">
                        </div>
                        <button id="create-room-btn" class="w-full bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">åˆ›å»ºæˆ¿é—´</button>
                    </div>
                    <div class="flex-1 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-medium mb-3">åŠ å…¥æˆ¿é—´</h3>
                        <div class="mb-4">
                            <label for="player-name-join" class="block mb-2 text-sm font-medium">ä½ çš„åå­—</label>
                            <input type="text" id="player-name-join" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" placeholder="è¾“å…¥ä½ çš„åå­—">
                        </div>
                        <div class="mb-4">
                            <label for="room-code" class="block mb-2 text-sm font-medium">æˆ¿é—´ä»£ç </label>
                            <input type="text" id="room-code" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" placeholder="è¾“å…¥æˆ¿é—´ä»£ç ">
                        </div>
                        <button id="join-room-btn" class="w-full bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">åŠ å…¥æˆ¿é—´</button>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">æ¸¸æˆè§„åˆ™</h2>
                <div class="prose dark:prose-invert max-w-none">
                    <p>ç‹¼äººæ€æ˜¯ä¸€ä¸ªå……æ»¡ä¹è¶£çš„æ¨ç†æ¸¸æˆï¼Œç©å®¶åˆ†ä¸ºç‹¼äººé˜µè¥å’Œå¥½äººé˜µè¥ã€‚</p>
                    <p>æ¸¸æˆåˆ†ä¸ºç™½å¤©å’Œé»‘å¤œï¼Œåœ¨é»‘å¤œé‡Œå„è§’è‰²æŒ‰é¡ºåºè¡ŒåŠ¨ä½¿ç”¨æŠ€èƒ½ï¼Œç™½å¤©æ‰€æœ‰ç©å®¶è®¨è®ºå¹¶æŠ•ç¥¨æ”¾é€ä¸€åç©å®¶ã€‚</p>
                    <p>å¥½äººé˜µè¥è·èƒœæ¡ä»¶ï¼šæ¸…é™¤æ‰€æœ‰ç‹¼äºº</p>
                    <p>ç‹¼äººé˜µè¥è·èƒœæ¡ä»¶ï¼šç‹¼äººæ•°é‡å¤§äºç­‰äºå¥½äººæ•°é‡</p>
                    
                    <h3 class="text-lg font-medium mt-4">è§’è‰²ä»‹ç»</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-medium text-wolf">ç‹¼äººé˜µè¥</h4>
                            <ul class="list-disc pl-5">
                                <li>ç‹¼äººï¼šæ¯æ™šå¯ä»¥æ€æ­»ä¸€åç©å®¶</li>
                                <li>ç‹¼ç‹ï¼šè¢«æ”¾é€æ—¶å¯ä»¥å¸¦èµ°ä¸€åç©å®¶</li>
                                <li>éšç‹¼ï¼šå¯¹é¢„è¨€å®¶çš„æŸ¥éªŒæ˜¾ç¤ºä¸ºå¥½äºº</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-medium text-villager">å¥½äººé˜µè¥</h4>
                            <ul class="list-disc pl-5">
                                <li>å¹³æ°‘ï¼šæ²¡æœ‰ç‰¹æ®ŠæŠ€èƒ½ï¼Œé æ¨ç†ä¿æŠ¤è‡ªå·±</li>
                                <li>å¥³å·«ï¼šæ‹¥æœ‰ä¸€ç“¶è§£è¯å’Œä¸€ç“¶æ¯’è¯</li>
                                <li>çŒäººï¼šè¢«æ”¾é€æˆ–æ­»äº¡æ—¶å¯ä»¥å¸¦èµ°ä¸€åç©å®¶</li>
                                <li>å®ˆå«ï¼šæ¯æ™šå¯ä»¥ä¿æŠ¤ä¸€åç©å®¶</li>
                                <li>é¢„è¨€å®¶ï¼šæ¯æ™šå¯ä»¥æŸ¥éªŒä¸€åç©å®¶çš„èº«ä»½</li>
                                <li>ç™½ç—´ï¼šè¢«æŠ•ç¥¨å‡ºå±€åä»ç„¶å¯ä»¥å‘è¨€ï¼Œä½†å¤±å»æŠ•ç¥¨æƒ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æˆ¿é—´è®¾ç½®å±å¹• -->
        <div id="room-setup-screen" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">æˆ¿é—´è®¾ç½®</h1>
                <div class="flex items-center">
                    <div class="mr-4">
                        <span class="font-medium">æˆ¿é—´ä»£ç ï¼š</span>
                        <span id="display-room-code" class="font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">XXXX</span>
                        <button id="copy-code-btn" class="text-primary hover:text-indigo-700 ml-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                        </button>
                    </div>
                    <button id="back-to-welcome-btn" class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">æ¸¸æˆè®¾ç½®</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="player-count" class="block mb-2 text-sm font-medium">ç©å®¶äººæ•°</label>
                        <select id="player-count" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <option value="6">6äºº</option>
                            <option value="7">7äºº</option>
                            <option value="8">8äºº</option>
                            <option value="9">9äºº</option>
                            <option value="10">10äºº</option>
                            <option value="11">11äºº</option>
                            <option value="12">12äºº</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium">æ¨èé…ç½®</label>
                        <button id="recommended-setup-btn" class="bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">ä½¿ç”¨æ¨èé…ç½®</button>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-medium mb-3">è§’è‰²é…ç½®</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        <div class="flex items-center">
                            <input type="number" id="role-wolf" min="0" max="5" value="2" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-wolf" class="ml-2">ç‹¼äºº</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-wolf-king" min="0" max="1" value="0" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-wolf-king" class="ml-2">ç‹¼ç‹</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-secret-wolf" min="0" max="1" value="0" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-secret-wolf" class="ml-2">éšç‹¼</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-villager" min="0" max="10" value="1" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-villager" class="ml-2">å¹³æ°‘</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-witch" min="0" max="1" value="1" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-witch" class="ml-2">å¥³å·«</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-hunter" min="0" max="1" value="1" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-hunter" class="ml-2">çŒäºº</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-guard" min="0" max="1" value="0" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-guard" class="ml-2">å®ˆå«</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-seer" min="0" max="1" value="1" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-seer" class="ml-2">é¢„è¨€å®¶</label>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="role-idiot" min="0" max="1" value="0" class="w-12 text-center px-2 py-1 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <label for="role-idiot" class="ml-2">ç™½ç—´</label>
                        </div>
                    </div>
                    <div class="mt-3 text-sm text-gray-600 dark:text-gray-400" id="role-count-warning">
                        å½“å‰é…ç½®ï¼šæ€»äººæ•° <span id="total-roles">6</span> / éœ€è¦ <span id="required-players">6</span> äºº
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ç©å®¶åˆ—è¡¨</h2>
                <ul id="player-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <li class="py-3 flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="inline-block h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                </svg>
                            </span>
                            <span class="font-medium">æˆ¿ä¸» (ä½ )</span>
                        </div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">å‡†å¤‡ä¸­</span>
                    </li>
                    <!-- å…¶ä»–ç©å®¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </ul>
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="start-game-btn" class="flex-1 bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">å¼€å§‹æ¸¸æˆ</button>
                    <button id="add-ai-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition">æ·»åŠ AIç©å®¶</button>
                </div>
            </div>
        </div>
        
        <!-- ç­‰å¾…æ¸¸æˆå¼€å§‹å±å¹• -->
        <div id="waiting-screen" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">ç­‰å¾…æ¸¸æˆå¼€å§‹</h1>
                <button id="leave-room-btn" class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">æˆ¿é—´ä¿¡æ¯</h2>
                <div class="mb-4">
                    <span class="font-medium">æˆ¿é—´ä»£ç ï¼š</span>
                    <span id="waiting-room-code" class="font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">XXXX</span>
                </div>
                <div class="mb-4">
                    <span class="font-medium">æˆ¿ä¸»ï¼š</span>
                    <span id="waiting-host-name">...</span>
                </div>
                <div>
                    <h3 class="font-medium mb-2">ç©å®¶åˆ—è¡¨</h3>
                    <ul id="waiting-player-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- ç©å®¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- æ¸¸æˆå±å¹• -->
        <div id="game-screen" class="hidden fade-in">
            <div class="relative" id="game-container">
                <!-- å¤œæ™šæ»¤é•œ -->
                <div id="night-overlay" class="hidden fixed inset-0 z-10 night-filter flex items-center justify-center">
                    <div class="text-center text-white">
                        <div class="text-6xl mb-4">ğŸŒ™</div>
                        <h2 class="text-2xl font-bold mb-2">å¤œæ™šé™ä¸´</h2>
                        <p class="text-lg" id="night-message">å®‰é™å…¥ç¡ï¼Œç­‰å¾…ä½ çš„å›åˆ...</p>
                    </div>
                </div>
                
                <!-- æ¸¸æˆå¤´éƒ¨ä¿¡æ¯ -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-2xl font-bold">ç‹¼äººæ€ <span id="game-phase-indicator" class="ml-2 text-sm font-normal px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">å‡†å¤‡é˜¶æ®µ</span></h1>
                    </div>
                    <div class="flex items-center">
                        <button id="game-menu-btn" class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- è§’è‰²ä¿¡æ¯ -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-4">
                    <div class="lg:col-span-3">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                            <h2 class="text-lg font-semibold mb-3">ä½ çš„è§’è‰²</h2>
                            <div class="flex justify-center">
                                <div class="role-card" id="player-role-card">
                                    <div class="role-card-inner">
                                        <div class="role-card-front bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                            <div class="text-4xl">â“</div>
                                        </div>
                                        <div class="role-card-back bg-primary flex flex-col items-center justify-center text-white p-2">
                                            <div id="role-icon" class="text-3xl mb-2">ğŸº</div>
                                            <div id="role-name" class="font-bold text-center">æœªçŸ¥è§’è‰²</div>
                                            <div id="role-team" class="text-xs mt-1">é˜µè¥ï¼šæœªçŸ¥</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="view-role-btn" class="w-full mt-4 bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">æŸ¥çœ‹è§’è‰²</button>
                            <div id="role-description" class="mt-4 text-sm hidden">
                                <p class="font-medium mb-1">è§’è‰²è¯´æ˜ï¼š</p>
                                <p>-</p>
                                <div id="role-ability" class="mt-2">
                                    <!-- è§’è‰²èƒ½åŠ›æŒ‰é’®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-9">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                            <h2 class="text-lg font-semibold mb-3">ç©å®¶çŠ¶æ€</h2>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" id="player-status-grid">
                                <!-- ç©å®¶çŠ¶æ€å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¸æˆæ—¥å¿—å’ŒèŠå¤© -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                        <h2 class="text-lg font-semibold mb-3">æ¸¸æˆæ—¥å¿—</h2>
                        <div id="game-log" class="h-64 overflow-y-auto p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 mb-3 text-sm">
                            <p class="text-gray-600 dark:text-gray-400">æ¸¸æˆå³å°†å¼€å§‹...</p>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                        <h2 class="text-lg font-semibold mb-3">èŠå¤©é¢æ¿ <span id="chat-status" class="ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">å¤œæ™šç¦è¨€</span></h2>
                        <div id="chat-messages" class="h-64 overflow-y-auto p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 mb-3 text-sm">
                            <p class="text-gray-600 dark:text-gray-400">ç™½å¤©åˆ°æ¥æ—¶æ‰èƒ½å‘è¨€...</p>
                        </div>
                        <div class="flex">
                            <input type="text" id="chat-input" class="flex-1 px-3 py-2 text-base border rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." disabled>
                            <button id="send-chat-btn" class="bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-r-md transition disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>å‘é€</button>
                        </div>
                    </div>
                </div>
                
                <!-- å‘è¨€è½®æ¬¡æŒ‡ç¤ºå™¨ -->
                <div id="speaking-turn-indicator" class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 hidden">
                    <h2 class="text-lg font-semibold mb-3">å‘è¨€ç¯èŠ‚</h2>
                    <p class="mb-3" id="speaking-instruction">å½“å‰ç©å®¶å‘è¨€ä¸­ï¼Œè¯·ç­‰å¾…è½®åˆ°ä½ å‘è¨€...</p>
                    <div class="flex flex-wrap gap-3 mb-4" id="speaking-order">
                        <!-- å‘è¨€é¡ºåºå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="mt-2">
                        <button id="next-speaker-btn" class="bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition hidden">ä¸‹ä¸€ä½å‘è¨€</button>
                        <div id="speaking-timer" class="text-sm text-gray-600 dark:text-gray-400 mt-1">å‰©ä½™æ—¶é—´: <span id="speaking-time-left">60</span>ç§’</div>
                    </div>
                </div>
                
                <!-- æŠ•ç¥¨åŒºåŸŸ -->
                <div id="vote-area" class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 hidden">
                    <h2 class="text-lg font-semibold mb-3">æŠ•ç¥¨ç¯èŠ‚</h2>
                    <p class="mb-3" id="vote-instruction">è¯·é€‰æ‹©ä¸€åç©å®¶è¿›è¡ŒæŠ•ç¥¨æ”¾é€ï¼š</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3" id="vote-options">
                        <!-- æŠ•ç¥¨é€‰é¡¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="mt-4">
                        <button id="confirm-vote-btn" class="bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">ç¡®è®¤æŠ•ç¥¨</button>
                        <button id="skip-vote-btn" class="ml-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition">å¼ƒæƒ</button>
                    </div>
                </div>
                
                <!-- ç‰¹æ®Šèƒ½åŠ›åŒºåŸŸ -->
                <div id="ability-area" class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 hidden">
                    <h2 class="text-lg font-semibold mb-3" id="ability-title">ä½¿ç”¨èƒ½åŠ›</h2>
                    <p class="mb-3" id="ability-instruction">è¯·é€‰æ‹©ä¸€åç©å®¶ï¼š</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3" id="ability-options">
                        <!-- èƒ½åŠ›é€‰é¡¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="mt-4">
                        <button id="confirm-ability-btn" class="bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">ç¡®è®¤</button>
                        <button id="skip-ability-btn" class="ml-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition">è·³è¿‡</button>
                    </div>
                </div>
                
                <!-- ç»“æœå¼¹çª— -->
                <div id="result-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                    <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                        <h2 class="text-2xl font-bold mb-4" id="result-title">æ¸¸æˆç»“æŸ</h2>
                        <div id="result-content" class="mb-6">
                            <!-- ç»“æœå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="flex justify-end">
                            <button id="new-game-btn" class="bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">è¿”å›ä¸»èœå•</button>
                        </div>
                    </div>
                </div>
                
                <!-- èœå•å¼¹çª— -->
                <div id="menu-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                    <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                        <h2 class="text-2xl font-bold mb-4">æ¸¸æˆèœå•</h2>
                        <div class="space-y-3">
                            <button id="resume-game-btn" class="w-full bg-primary hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-md transition">ç»§ç»­æ¸¸æˆ</button>
                            <button id="rules-btn" class="w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition">æŸ¥çœ‹è§„åˆ™</button>
                            <button id="quit-game-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition">é€€å‡ºæ¸¸æˆ</button>
                        </div>
                    </div>
                </div>
                
                <!-- æ·»åŠ AIç©å®¶å¼¹çª— -->
                <div id="add-ai-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                    <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                        <h2 class="text-2xl font-bold mb-4">æ·»åŠ AIç©å®¶</h2>
                        <div class="mb-4">
                            <label for="ai-player-name" class="block mb-2 text-sm font-medium">AIç©å®¶åå­—</label>
                            <input type="text" id="ai-player-name" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" placeholder="è¾“å…¥AIç©å®¶åå­—">
                        </div>
                        <div class="mb-4">
                            <label for="ai-player-personality" class="block mb-2 text-sm font-medium">AIç©å®¶æ€§æ ¼</label>
                            <select id="ai-player-personality" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                                <option value="cautious">è°¨æ…å‹ - ä¸è½»æ˜“è¡¨æ€ï¼Œå–„äºéšè—èº«ä»½</option>
                                <option value="aggressive">æ¿€è¿›å‹ - æ•¢äºè´¨ç–‘ä»–äººï¼Œå‘è¨€ç›´æ¥</option>
                                <option value="logical">é€»è¾‘å‹ - åˆ†ææ¨ç†èƒ½åŠ›å¼ºï¼Œå–„äºæ‰¾å‡ºçŸ›ç›¾</option>
                                <option value="emotional">æƒ…ç»ªå‹ - å®¹æ˜“æƒ…ç»ªåŒ–ï¼Œåˆ¤æ–­å¤šåŸºäºç›´è§‰</option>
                                <option value="talkative">è¯å¤šå‹ - å–œæ¬¢åˆ†äº«ä¿¡æ¯ï¼Œä½†å®¹æ˜“æš´éœ²</option>
                                <option value="random">éšæœºæ€§æ ¼</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button id="cancel-add-ai-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition">å–æ¶ˆ</button>
                            <button id="confirm-add-ai-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æš—é»‘æ¨¡å¼æ”¯æŒ
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // æ¸¸æˆå¸¸é‡å’Œé…ç½®
        const ROLE_ICONS = {
            'wolf': 'ğŸº',
            'wolf-king': 'ğŸ‘‘',
            'secret-wolf': 'ğŸ¦Š',
            'villager': 'ğŸ‘¨â€ğŸŒ¾',
            'witch': 'ğŸ§™â€â™€ï¸',
            'hunter': 'ğŸ”«',
            'guard': 'ğŸ›¡ï¸',
            'seer': 'ğŸ‘ï¸',
            'idiot': 'ğŸƒ'
        };

        const ROLE_NAMES = {
            'wolf': 'ç‹¼äºº',
            'wolf-king': 'ç‹¼ç‹',
            'secret-wolf': 'éšç‹¼',
            'villager': 'å¹³æ°‘',
            'witch': 'å¥³å·«',
            'hunter': 'çŒäºº',
            'guard': 'å®ˆå«',
            'seer': 'é¢„è¨€å®¶',
            'idiot': 'ç™½ç—´'
        };

        const ROLE_TEAMS = {
            'wolf': 'ç‹¼äººé˜µè¥',
            'wolf-king': 'ç‹¼äººé˜µè¥',
            'secret-wolf': 'ç‹¼äººé˜µè¥',
            'villager': 'å¥½äººé˜µè¥',
            'witch': 'å¥½äººé˜µè¥',
            'hunter': 'å¥½äººé˜µè¥',
            'guard': 'å¥½äººé˜µè¥',
            'seer': 'å¥½äººé˜µè¥',
            'idiot': 'å¥½äººé˜µè¥'
        };

        const ROLE_DESCRIPTIONS = {
            'wolf': 'ä½ æ˜¯ç‹¼äººï¼Œæ¯æ™šå¯ä»¥å’Œå…¶ä»–ç‹¼äººä¸€èµ·æ€æ­»ä¸€åç©å®¶ã€‚',
            'wolf-king': 'ä½ æ˜¯ç‹¼ç‹ï¼Œæ‹¥æœ‰ç‹¼äººçš„èƒ½åŠ›ï¼Œå¹¶ä¸”è¢«æ”¾é€æ—¶å¯ä»¥å¸¦èµ°ä¸€åç©å®¶ã€‚',
            'secret-wolf': 'ä½ æ˜¯éšç‹¼ï¼Œå¯¹é¢„è¨€å®¶çš„æŸ¥éªŒæ˜¾ç¤ºä¸ºå¥½äººï¼Œä½†ä½ å±äºç‹¼äººé˜µè¥ã€‚',
            'villager': 'ä½ æ˜¯å¹³æ°‘ï¼Œæ²¡æœ‰ç‰¹æ®ŠæŠ€èƒ½ï¼Œè¯·é€šè¿‡æ¨ç†æ‰¾å‡ºç‹¼äººã€‚',
            'witch': 'ä½ æ˜¯å¥³å·«ï¼Œæ‹¥æœ‰ä¸€ç“¶è§£è¯å’Œä¸€ç“¶æ¯’è¯ï¼Œæ¯ç§è¯åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚',
            'hunter': 'ä½ æ˜¯çŒäººï¼Œè¢«æ”¾é€æˆ–è¢«æ€æ­»æ—¶å¯ä»¥å¼€æªå¸¦èµ°ä¸€åç©å®¶ã€‚',
            'guard': 'ä½ æ˜¯å®ˆå«ï¼Œæ¯æ™šå¯ä»¥ä¿æŠ¤ä¸€åç©å®¶å…å—ç‹¼äººçš„ä¼¤å®³ï¼Œä½†ä¸èƒ½è¿ç»­ä¸¤æ™šä¿æŠ¤åŒä¸€ä¸ªäººã€‚',
            'seer': 'ä½ æ˜¯é¢„è¨€å®¶ï¼Œæ¯æ™šå¯ä»¥æŸ¥éªŒä¸€åç©å®¶æ˜¯å¥½äººè¿˜æ˜¯ç‹¼äººï¼ˆéšç‹¼é™¤å¤–ï¼‰ã€‚',
            'idiot': 'ä½ æ˜¯ç™½ç—´ï¼Œè¢«æŠ•ç¥¨å‡ºå±€åä¿ç•™å‘è¨€æƒï¼Œä½†å¤±å»æŠ•ç¥¨æƒã€‚'
        };

        const RECOMMENDED_SETUPS = {
            6: { 'wolf': 2, 'wolf-king': 0, 'secret-wolf': 0, 'villager': 1, 'witch': 1, 'hunter': 1, 'guard': 0, 'seer': 1, 'idiot': 0 },
            7: { 'wolf': 2, 'wolf-king': 0, 'secret-wolf': 0, 'villager': 2, 'witch': 1, 'hunter': 1, 'guard': 0, 'seer': 1, 'idiot': 0 },
            8: { 'wolf': 2, 'wolf-king': 1, 'secret-wolf': 0, 'villager': 2, 'witch': 1, 'hunter': 1, 'guard': 0, 'seer': 1, 'idiot': 0 },
            9: { 'wolf': 3, 'wolf-king': 0, 'secret-wolf': 0, 'villager': 3, 'witch': 1, 'hunter': 1, 'guard': 0, 'seer': 1, 'idiot': 0 },
            10: { 'wolf': 3, 'wolf-king': 0, 'secret-wolf': 1, 'villager': 3, 'witch': 1, 'hunter': 1, 'guard': 0, 'seer': 1, 'idiot': 0 },
            11: { 'wolf': 3, 'wolf-king': 1, 'secret-wolf': 0, 'villager': 3, 'witch': 1, 'hunter': 1, 'guard': 1, 'seer': 1, 'idiot': 0 },
            12: { 'wolf': 4, 'wolf-king': 0, 'secret-wolf': 0, 'villager': 4, 'witch': 1, 'hunter': 1, 'guard': 1, 'seer': 1, 'idiot': 0 }
        };

        // AIæ€§æ ¼ç‰¹å¾é…ç½®
        const AI_PERSONALITIES = {
            cautious: {
                roleRevealChance: 0.2,  // ç›´æ¥æš´éœ²èº«ä»½çš„å‡ ç‡
                falseClaim: 0.3,        // è™šå‡å£°æ˜çš„å‡ ç‡ï¼ˆç‹¼äººå†’å……å¥½äººï¼‰
                accusationThreshold: 0.7, // æŒ‡æ§ä»–äººçš„é˜ˆå€¼
                persuasivenessFactor: 0.6, // è¯´æœåŠ›å› å­
                selfDefenseStrength: 0.8, // è‡ªæˆ‘è¾©æŠ¤å¼ºåº¦
                description: "è°¨æ…å‹AIï¼Œä¸è½»æ˜“è¡¨éœ²ç«‹åœºï¼Œå–„äºéšè—èº«ä»½"
            },
            aggressive: {
                roleRevealChance: 0.4,
                falseClaim: 0.5,
                accusationThreshold: 0.4,
                persuasivenessFactor: 0.7,
                selfDefenseStrength: 0.6,
                description: "æ¿€è¿›å‹AIï¼Œæ•¢äºè´¨ç–‘ä»–äººï¼Œå‘è¨€ç›´æ¥"
            },
            logical: {
                roleRevealChance: 0.3,
                falseClaim: 0.2,
                accusationThreshold: 0.6,
                persuasivenessFactor: 0.8,
                selfDefenseStrength: 0.7,
                description: "é€»è¾‘å‹AIï¼Œåˆ†ææ¨ç†èƒ½åŠ›å¼ºï¼Œå–„äºæ‰¾å‡ºçŸ›ç›¾"
            },
            emotional: {
                roleRevealChance: 0.5,
                falseClaim: 0.4,
                accusationThreshold: 0.3,
                persuasivenessFactor: 0.5,
                selfDefenseStrength: 0.5,
                description: "æƒ…ç»ªå‹AIï¼Œå®¹æ˜“æƒ…ç»ªåŒ–ï¼Œåˆ¤æ–­å¤šåŸºäºç›´è§‰"
            },
            talkative: {
                roleRevealChance: 0.6,
                falseClaim: 0.3,
                accusationThreshold: 0.5,
                persuasivenessFactor: 0.6,
                selfDefenseStrength: 0.6,
                description: "è¯å¤šå‹AIï¼Œå–œæ¬¢åˆ†äº«ä¿¡æ¯ï¼Œä½†å®¹æ˜“æš´éœ²"
            }
        };

        // ç”Ÿæˆå‘è¨€æ¨¡æ¿åº“
        const SPEECH_TEMPLATES = {
            // é€šç”¨å‘è¨€
            generic: {
                greeting: [
                    "å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯{name}ã€‚",
                    "å„ä½æ—©ä¸Šå¥½ï¼Œä½œä¸º{name}ï¼Œæˆ‘æƒ³è¯´å‡ å¥ã€‚",
                    "å¥½çš„ï¼Œè½®åˆ°æˆ‘{name}å‘è¨€äº†ã€‚"
                ],
                neutral: [
                    "æˆ‘è®¤ä¸ºç›®å‰ä¿¡æ¯è¿˜ä¸å¤Ÿå¤šï¼Œéœ€è¦å¤§å®¶å¤šäº¤æµã€‚",
                    "æˆ‘ä»¬å…ˆå¬å¬æ¯ä¸ªäººçš„å‘è¨€ï¼Œå†åšåˆ¤æ–­å§ã€‚",
                    "ç°åœ¨ä¸‹ç»“è®ºè¿˜ä¸ºæ—¶è¿‡æ—©ï¼Œå¤šè§‚å¯Ÿä¸€ä¸‹å±€åŠ¿ã€‚",
                    "æˆ‘è§‰å¾—è¿™ä¸€è½®å¤§å®¶çš„å‘è¨€éƒ½æŒºæ­£å¸¸çš„ã€‚",
                    "æˆ‘æš‚æ—¶æ²¡æœ‰ç‰¹åˆ«æ€€ç–‘çš„å¯¹è±¡ã€‚"
                ],
                suspect: [
                    "æˆ‘è§‰å¾—{target}çš„å‘è¨€æœ‰äº›å¥‡æ€ªï¼Œå¤§å®¶æ³¨æ„ä¸€ä¸‹ã€‚",
                    "{target}åˆšæ‰çš„è¡¨ç°æœ‰ç‚¹å¯ç–‘ï¼Œå¯èƒ½éœ€è¦è§£é‡Šä¸€ä¸‹ã€‚",
                    "æˆ‘ä¸ªäººè®¤ä¸º{target}çš„è¡Œä¸ºæœ‰äº›åå¸¸ï¼Œä¸çŸ¥é“å¤§å®¶æ€ä¹ˆçœ‹ï¼Ÿ",
                    "å¬äº†{target}çš„å‘è¨€ï¼Œæˆ‘æ„Ÿè§‰æœ‰äº›åœ°æ–¹ä¸å¤ªè‡ªç„¶ã€‚"
                ],
                defend: [
                    "æˆ‘ä¸æ˜¯ç‹¼äººï¼Œè¯·å¤§å®¶ç›¸ä¿¡æˆ‘ã€‚",
                    "æˆ‘æ˜¯å¥½äººï¼Œä¸è¦è¢«è¯¯å¯¼äº†ã€‚",
                    "æˆ‘çœŸçš„æ˜¯å¥½äººé˜µè¥ï¼ŒæŠ•æˆ‘å‡ºå±€å¯¹å¥½äººä¸åˆ©ã€‚",
                    "æˆ‘æ˜ç™½çœ‹èµ·æ¥å¾ˆå¯ç–‘ï¼Œä½†æˆ‘ç¡®å®ä¸æ˜¯ç‹¼äººã€‚"
                ],
                closing: [
                    "æˆ‘çš„å‘è¨€ç»“æŸï¼Œè°¢è°¢å¤§å®¶ã€‚",
                    "ä»¥ä¸Šæ˜¯æˆ‘çš„çœ‹æ³•ï¼Œä¸‹ä¸€ä½è¯·ã€‚",
                    "å°±è¯´è¿™ä¹ˆå¤šå§ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰å¸®åŠ©ã€‚",
                    "æˆ‘è¯´å®Œäº†ï¼Œè¯·å¤§å®¶ä»”ç»†æ€è€ƒã€‚"
                ]
            },
            
            // è§’è‰²ç‰¹å®šå‘è¨€
            villager: {
                claim: [
                    "æˆ‘æ˜¯ä¸€åå¹³æ°‘ï¼Œæ²¡æœ‰ç‰¹æ®Šèƒ½åŠ›ï¼Œåªèƒ½é æ¨ç†ã€‚",
                    "æˆ‘æ˜¯å¹³æ°‘ï¼Œå¸Œæœ›æœ‰ç‰¹æ®Šèº«ä»½çš„å¥½äººèƒ½ç«™å‡ºæ¥å¸¦é¢†æˆ‘ä»¬ã€‚",
                    "ä½œä¸ºå¹³æ°‘ï¼Œæˆ‘åªèƒ½é€šè¿‡è§‚å¯Ÿå¤§å®¶çš„è¨€è¡Œæ¥æ‰¾å‡ºç‹¼äººã€‚"
                ],
                analysis: [
                    "ä»ç›®å‰çš„æƒ…å†µçœ‹ï¼Œæˆ‘æ„Ÿè§‰{target}å¯èƒ½æ˜¯ç‹¼äººã€‚",
                    "è™½ç„¶æˆ‘åªæ˜¯å¹³æ°‘ï¼Œä½†æˆ‘è§‰å¾—{target}çš„å‘è¨€å¾ˆçŸ›ç›¾ã€‚",
                    "ä½œä¸ºä¸€ä¸ªå¹³æ°‘ï¼Œæˆ‘çš„ç›´è§‰å‘Šè¯‰æˆ‘{target}ä¸å¤ªå¯¹åŠ²ã€‚"
                ]
            },
            
            wolf: {
                fake_claim: [
                    "æˆ‘å…¶å®æ˜¯é¢„è¨€å®¶ï¼Œæ˜¨æ™šæˆ‘æŸ¥éªŒäº†{target}ï¼Œä»–æ˜¯å¥½äººã€‚",
                    "æˆ‘æ˜¯å®ˆå«ï¼Œæ˜¨æ™šæˆ‘ä¿æŠ¤äº†{target}ã€‚",
                    "ä½œä¸ºä¸€åå¹³æ°‘ï¼Œæˆ‘åªèƒ½å°½åŠ›åˆ†æå¤§å®¶çš„å‘è¨€ã€‚",
                    "æˆ‘æ˜¯å¥³å·«ï¼Œæ˜¨æ™šæˆ‘ç”¨äº†è§£è¯æ•‘äº†è¢«ç‹¼äººè¢­å‡»çš„äººã€‚"
                ],
                accusation: [
                    "æˆ‘è§‰å¾—{target}å¾ˆå¯èƒ½æ˜¯ç‹¼äººï¼Œä»–çš„å‘è¨€å‰åçŸ›ç›¾ã€‚",
                    "å¤§å®¶æ³¨æ„ä¸€ä¸‹{target}ï¼Œä»–å¥½åƒåœ¨åˆ»æ„è½¬ç§»è§†çº¿ã€‚",
                    "æˆ‘è®¤ä¸º{target}æœ€å¯ç–‘ï¼Œä»–ä¸€ç›´åœ¨è¯¯å¯¼å¤§å®¶ã€‚",
                    "{target}çš„è¡Œä¸ºå¾ˆåƒæ˜¯åœ¨ä¼ªè£…ï¼Œå»ºè®®å¤§å®¶æŠ•ä»–ã€‚"
                ],
                defense: [
                    "æˆ‘ä¸æ˜¯ç‹¼äººï¼Œå¯èƒ½æ˜¯é¢„è¨€å®¶æŸ¥é”™äº†ã€‚",
                    "é¢„è¨€å®¶å¯èƒ½è¢«ç‹¼äººå†’å……äº†ï¼Œæˆ‘æ˜¯å¥½äººã€‚",
                    "ä¸è¦è¢«è¡¨é¢ç°è±¡è¿·æƒ‘ï¼ŒçœŸæ­£çš„ç‹¼äººæ˜¯{target}ã€‚",
                    "å¤§å®¶å†·é™ä¸€ä¸‹ï¼ŒæŠ•æˆ‘å‡ºå±€å¯¹å¥½äººé˜µè¥ä¸åˆ©ã€‚"
                ]
            },
            
            seer: {
                claim: [
                    "æˆ‘æ˜¯é¢„è¨€å®¶ï¼Œæ˜¨æ™šæˆ‘æŸ¥éªŒäº†{target}ï¼Œä»–æ˜¯{result}ã€‚",
                    "ä½œä¸ºé¢„è¨€å®¶ï¼Œæˆ‘è¦å‘Šè¯‰å¤§å®¶{target}æ˜¯{result}ã€‚",
                    "æˆ‘æ˜¯é¢„è¨€å®¶ï¼Œæˆ‘æ˜¨æ™šæŸ¥åˆ°{target}æ˜¯{result}ï¼Œè¯·å¤§å®¶ç›¸ä¿¡æˆ‘ã€‚"
                ],
                reasoning: [
                    "æ ¹æ®æˆ‘çš„æŸ¥éªŒç»“æœï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå¤„ç†å·²çŸ¥çš„ç‹¼äººã€‚",
                    "æˆ‘å»ºè®®å¤§å®¶ç›¸ä¿¡æˆ‘çš„æŸ¥éªŒï¼Œé›†ä¸­ç«åŠ›å¤„ç†ç‹¼äººã€‚",
                    "ä½œä¸ºé¢„è¨€å®¶ï¼Œæˆ‘çš„ä¿¡æ¯å¯¹å¥½äººé˜µè¥è‡³å…³é‡è¦ã€‚"
                ]
            },
            
            witch: {
                claim: [
                    "æˆ‘æ˜¯å¥³å·«ï¼Œæ˜¨æ™šæˆ‘{action}ã€‚",
                    "ä½œä¸ºå¥³å·«ï¼Œæˆ‘æƒ³å‘Šè¯‰å¤§å®¶æ˜¨æ™šæˆ‘{action}ã€‚",
                    "æˆ‘æ˜¯å¥³å·«ï¼Œæˆ‘{action}ï¼Œå¸Œæœ›è¿™ä¸ªä¿¡æ¯å¯¹å¤§å®¶æœ‰å¸®åŠ©ã€‚"
                ],
                strategy: [
                    "æˆ‘çš„è§£è¯å’Œæ¯’è¯éƒ½è¿˜åœ¨ï¼Œéœ€è¦è°¨æ…ä½¿ç”¨ã€‚",
                    "æˆ‘å·²ç»ç”¨æ‰äº†è§£è¯ï¼Œä½†æ¯’è¯è¿˜åœ¨ï¼Œè¯·å¤§å®¶ç»™æˆ‘æä¾›çº¿ç´¢ã€‚",
                    "æˆ‘çš„ä¸¤ç“¶è¯éƒ½ç”¨å®Œäº†ï¼Œä½†å¸Œæœ›æˆ‘æä¾›çš„ä¿¡æ¯èƒ½å¸®åŠ©å¤§å®¶ã€‚"
                ]
            },
            
            hunter: {
                claim: [
                    "æˆ‘æ˜¯çŒäººï¼Œå¦‚æœæˆ‘è¢«æŠ•å‡ºå»ï¼Œæˆ‘ä¼šå¼€æªå¸¦èµ°æˆ‘è®¤ä¸ºçš„ç‹¼äººã€‚",
                    "ä½œä¸ºçŒäººï¼Œæˆ‘å¸Œæœ›å¤§å®¶ä¸è¦æŠ•æˆ‘ï¼Œæˆ‘çš„èƒ½åŠ›å¯¹å¥½äººé˜µè¥å¾ˆé‡è¦ã€‚",
                    "æˆ‘æ˜¯çŒäººï¼Œå³ä½¿æˆ‘æ­»äº†ä¹Ÿèƒ½å¸¦èµ°ä¸€ä¸ªäººï¼Œç‹¼äººæœ€å¥½åˆ«æƒ¹æˆ‘ã€‚"
                ],
                threat: [
                    "å¦‚æœæˆ‘è¢«æŠ•å‡ºï¼Œæˆ‘ä¼šå¼€æªæ‰“æ­»{target}ï¼Œæˆ‘æ€€ç–‘ä»–æ˜¯ç‹¼äººã€‚",
                    "ç‹¼äººä»¬è¦å°å¿ƒï¼Œå°±ç®—æˆ‘æ­»äº†ä¹Ÿèƒ½å¸¦èµ°ä½ ä»¬ä¸­çš„ä¸€ä¸ªã€‚",
                    "æˆ‘çš„èƒ½åŠ›æ˜¯åŒåˆƒå‰‘ï¼ŒæŠ•æˆ‘å‡ºå±€ä¸ä¸€å®šå¯¹ç‹¼äººæœ‰åˆ©ã€‚"
                ]
            },
            
            guard: {
                claim: [
                    "æˆ‘æ˜¯å®ˆå«ï¼Œæ˜¨æ™šæˆ‘ä¿æŠ¤äº†{target}ã€‚",
                    "ä½œä¸ºå®ˆå«ï¼Œæˆ‘æ˜¨æ™šå®ˆæŠ¤äº†{target}ï¼Œä»–åº”è¯¥å¹³å®‰æ— äº‹ã€‚",
                    "æˆ‘æ˜¯å®ˆå«ï¼Œæˆ‘é€‰æ‹©ä¿æŠ¤{target}ï¼Œå¸Œæœ›æ²¡æœ‰ä¿æŠ¤é”™äººã€‚"
                ],
                strategy: [
                    "æˆ‘ä¼šå°½é‡ä¿æŠ¤å…³é”®è§’è‰²ï¼Œè¯·é¢„è¨€å®¶æˆ–å¥³å·«ç§ä¸‹å‘Šè¯‰æˆ‘ä½ ä»¬æ˜¯è°ã€‚",
                    "æˆ‘ä¸èƒ½è¿ç»­ä¸¤æ™šä¿æŠ¤åŒä¸€ä¸ªäººï¼Œæ‰€ä»¥éœ€è¦åˆç†å®‰æ’ã€‚",
                    "å®ˆå«çš„ä½œç”¨æ˜¯é˜»æ­¢ç‹¼äººå‡»æ€ï¼Œæˆ‘ä¼šå°½åŠ›ä¿æŠ¤å¥½äººé˜µè¥ã€‚"
                ]
            },
            
            idiot: {
                claim: [
                    "æˆ‘æ˜¯ç™½ç—´ï¼Œå³ä½¿è¢«æŠ•å‡ºå±€ä¹Ÿèƒ½ç»§ç»­å‘è¨€ã€‚",
                    "ä½œä¸ºç™½ç—´ï¼Œæˆ‘è¢«æŠ•å‡ºåè¿˜èƒ½è¯´è¯ï¼Œä½†æ²¡æœ‰æŠ•ç¥¨æƒã€‚",
                    "æˆ‘æ˜¯ç™½ç—´ï¼ŒæŠ•æˆ‘å‡ºå±€ä¸ä¼šè®©æˆ‘é—­å˜´ï¼Œä½†ä¼šæµªè´¹ä¸€æ¬¡æœºä¼šã€‚"
                ],
                argument: [
                    "å³ä½¿æˆ‘å·²ç»å‡ºå±€ï¼Œæˆ‘ä¹Ÿè¦è¯´{target}å¾ˆå¯ç–‘ã€‚",
                    "è™½ç„¶æˆ‘æ²¡æœ‰æŠ•ç¥¨æƒäº†ï¼Œä½†æˆ‘çš„åˆ¤æ–­æ˜¯{target}æœ€åƒç‹¼äººã€‚",
                    "ä½œä¸ºä¸€ä¸ªå·²å‡ºå±€çš„ç™½ç—´ï¼Œæˆ‘è§‚å¯Ÿåˆ°{target}è¡Œä¸ºåå¸¸ã€‚"
                ]
            }
        };

        // å…¨å±€æ¸¸æˆçŠ¶æ€
        const gameState = {
            isHost: false,
            roomCode: null,
            peer: null,
            connections: {},
            players: [],
            aiPlayers: [],
            playerName: '',
            playerRole: null,
            roleSettings: {},
            gamePhase: 'waiting',
            day: 0,
            currentTurn: null,
            speakingQueue: [],
            currentSpeaker: null,
            speakingTimeLeft: 60,
            speakingTimer: null,
            votes: {},
            wolfVotes: {},
            witchSaveTarget: null,
            witchPoisonTarget: null,
            witchSaveUsed: false,
            witchPoisonUsed: false,
            guardTarget: null,
            lastGuardTarget: null,
            seerTarget: null,
            killedAtNight: null,
            savedByWitch: false,
            poisonedByWitch: null,
            huntedByHunter: null,
            hunterDead: false,
            wolfKingDead: false,
            selectedAbilityTarget: null,
            deadPlayers: [],
            winningTeam: null,
            gameStarted: false,
            gameEnded: false,
            villagerCount: 0,
            wolfCount: 0,
            spectators: [],
            inited: false
        };

        // é€šç”¨å·¥å…·å‡½æ•°
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function showScreen(screenId) {
            document.querySelectorAll('#app > div').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function updatePlayerList() {
            const list = document.getElementById('player-list');
            list.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'py-3 flex justify-between items-center';
                
                const isAI = player.isAI;
                const isYou = player.id === gameState.peer.id;
                const isHost = player.id === gameState.players[0]?.id;
                
                let nameDisplay = player.name;
                if (isYou) nameDisplay += ' (ä½ )';
                if (isHost) nameDisplay = 'æˆ¿ä¸» ' + nameDisplay;
                if (isAI) nameDisplay += ' [AI]';
                
                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="inline-block h-8 w-8 rounded-full ${isAI ? 'bg-green-500' : 'bg-primary'} text-white flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        <span class="font-medium">${nameDisplay}</span>
                    </div>
                    <span class="text-sm text-gray-600 dark:text-gray-400">å‡†å¤‡ä¸­</span>
                `;
                list.appendChild(li);
                
                // å¦‚æœæ˜¯æˆ¿ä¸»ä¸”ä¸æ˜¯è‡ªå·±ï¼Œæ·»åŠ ç§»é™¤æŒ‰é’®
                if (gameState.isHost && !isYou && !gameState.gameStarted) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'ml-2 text-red-500 hover:text-red-700';
                    removeBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    `;
                    
                    removeBtn.addEventListener('click', () => {
                        if (player.isAI) {
                            // ç§»é™¤AIç©å®¶
                            gameState.players = gameState.players.filter(p => p.id !== player.id);
                            updatePlayerList();
                            // å¹¿æ’­ç©å®¶åˆ—è¡¨æ›´æ–°
                            broadcastGameState();
                        } else {
                            // æç¤ºæ˜¯å¦ç§»é™¤çœŸå®ç©å®¶
                            if (confirm(`ç¡®å®šè¦å°† ${player.name} ç§»å‡ºæˆ¿é—´å—ï¼Ÿ`)) {
                                // å‘é€ç§»é™¤æ¶ˆæ¯ç»™è¯¥ç©å®¶
                                gameState.connections[player.id].send({
                                    type: 'kick',
                                    message: 'ä½ å·²è¢«æˆ¿ä¸»ç§»å‡ºæˆ¿é—´'
                                });
                                // ä»ç©å®¶åˆ—è¡¨ä¸­ç§»é™¤
                                gameState.players = gameState.players.filter(p => p.id !== player.id);
                                updatePlayerList();
                                // å¹¿æ’­ç©å®¶åˆ—è¡¨æ›´æ–°
                                broadcastGameState();
                            }
                        }
                    });
                    
                    li.querySelector('div:last-child').prepend(removeBtn);
                }
            });
            
            // æ›´æ–°ç­‰å¾…é¡µé¢çš„ç©å®¶åˆ—è¡¨
            const waitingList = document.getElementById('waiting-player-list');
            if (waitingList) {
                waitingList.innerHTML = '';
                gameState.players.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'py-3 flex items-center';
                    
                    const isAI = player.isAI;
                    const isYou = player.id === gameState.peer.id;
                    const isHost = player.id === gameState.players[0]?.id;
                    
                    let nameDisplay = player.name;
                    if (isYou) nameDisplay += ' (ä½ )';
                    if (isHost) nameDisplay = 'æˆ¿ä¸» ' + nameDisplay;
                    if (isAI) nameDisplay += ' [AI]';
                    
                    li.innerHTML = `
                        <span class="inline-block h-8 w-8 rounded-full ${isAI ? 'bg-green-500' : 'bg-primary'} text-white flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        <span class="font-medium">${nameDisplay}</span>
                    `;
                    waitingList.appendChild(li);
                });
            }
        }

        function updateRoleCountWarning() {
            const totalRoles = calculateTotalRoles();
            const requiredPlayers = document.getElementById('player-count').value;
            
            document.getElementById('total-roles').textContent = totalRoles;
            document.getElementById('required-players').textContent = requiredPlayers;
            
            const warningElement = document.getElementById('role-count-warning');
            
            if (totalRoles != requiredPlayers) {
                warningElement.classList.add('text-red-600', 'dark:text-red-400');
                warningElement.classList.remove('text-gray-600', 'dark:text-gray-400');
            } else {
                warningElement.classList.remove('text-red-600', 'dark:text-red-400');
                warningElement.classList.add('text-gray-600', 'dark:text-gray-400');
            }
        }

        function calculateTotalRoles() {
            let total = 0;
            const roleIds = ['wolf', 'wolf-king', 'secret-wolf', 'villager', 'witch', 'hunter', 'guard', 'seer', 'idiot'];
            
            roleIds.forEach(roleId => {
                const element = document.getElementById(`role-${roleId}`);
                total += parseInt(element.value);
            });
            
            return total;
        }

        function updateRoleSettings() {
            const roleIds = ['wolf', 'wolf-king', 'secret-wolf', 'villager', 'witch', 'hunter', 'guard', 'seer', 'idiot'];
            
            roleIds.forEach(roleId => {
                const element = document.getElementById(`role-${roleId}`);
                gameState.roleSettings[roleId] = parseInt(element.value);
            });
        }

        function applyRecommendedSetup() {
            const playerCount = document.getElementById('player-count').value;
            const setup = RECOMMENDED_SETUPS[playerCount];
            
            if (setup) {
                for (const [roleId, count] of Object.entries(setup)) {
                    document.getElementById(`role-${roleId}`).value = count;
                }
                updateRoleCountWarning();
            }
        }

        function getRandomWolfStatement(aiPlayer, players, deadPlayers) {
            const personality = AI_PERSONALITIES[aiPlayer.personality];
            const templates = SPEECH_TEMPLATES.wolf;
            const generic = SPEECH_TEMPLATES.generic;
            
            // å†³å®šæ˜¯å¦å†’å……å¥½äººèº«ä»½
            const willFakeClaim = Math.random() < personality.falseClaim;
            
            // éšæœºé€‰æ‹©æ´»ç€çš„éç‹¼é˜Ÿå‹ä½œä¸ºç›®æ ‡
            const alivePlayers = players.filter(p => !deadPlayers.includes(p.id) && 
                                             !['wolf', 'wolf-king', 'secret-wolf'].includes(p.role));
            
            const targetPlayer = alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
            let statement = "";
            
            // æ·»åŠ é—®å€™
            statement += generic.greeting[Math.floor(Math.random() * generic.greeting.length)].replace('{name}', aiPlayer.name);
            statement += " ";
            
            // å¦‚æœå†³å®šå†’å……å¥½äººèº«ä»½
            if (willFakeClaim) {
                // éšæœºé€‰æ‹©ä¸€ä¸ªå†’å……èº«ä»½çš„è¯æœ¯
                const fakeClaim = templates.fake_claim[Math.floor(Math.random() * templates.fake_claim.length)]
                    .replace('{target}', targetPlayer ? targetPlayer.name : 'æŸä¸ªç©å®¶');
                statement += fakeClaim;
                statement += " ";
            } else {
                // ä½¿ç”¨ä¸­æ€§å‘è¨€
                statement += generic.neutral[Math.floor(Math.random() * generic.neutral.length)];
                statement += " ";
            }
            
            // æ·»åŠ å¯¹æŸäººçš„æŒ‡æ§ï¼Œè½¬ç§»è§†çº¿
            if (targetPlayer && Math.random() < personality.accusationThreshold) {
                const accusation = templates.accusation[Math.floor(Math.random() * templates.accusation.length)]
                    .replace('{target}', targetPlayer.name);
                statement += accusation;
                statement += " ";
            }
            
            // å¦‚æœè¢«æ€€ç–‘ï¼Œæ·»åŠ é˜²å¾¡å‘è¨€
            if (aiPlayer.isAccused && Math.random() < personality.selfDefenseStrength) {
                const defense = templates.defense[Math.floor(Math.random() * templates.defense.length)]
                    .replace('{target}', targetPlayer ? targetPlayer.name : 'æŸä¸ªç©å®¶');
                statement += defense;
                statement += " ";
            }
            
            // æ·»åŠ ç»“æŸè¯­
            statement += generic.closing[Math.floor(Math.random() * generic.closing.length)];
            
            return statement;
        }

        function getRandomVillagerStatement(aiPlayer, players, deadPlayers, role = 'villager') {
            const personality = AI_PERSONALITIES[aiPlayer.personality];
            const templates = SPEECH_TEMPLATES[role] || SPEECH_TEMPLATES.villager;
            const generic = SPEECH_TEMPLATES.generic;
            
            // å†³å®šæ˜¯å¦é€éœ²èº«ä»½
            const willReveal = Math.random() < personality.roleRevealChance;
            
            // éšæœºé€‰æ‹©æ´»ç€çš„ç©å®¶ä½œä¸ºç›®æ ‡
            const alivePlayers = players.filter(p => !deadPlayers.includes(p.id) && p.id !== aiPlayer.id);
            const suspiciousPlayers = aiPlayer.suspicions || [];
            
            // ä¼˜å…ˆé€‰æ‹©æ€€ç–‘åå•ä¸­çš„ç©å®¶
            let targetPlayer = null;
            if (suspiciousPlayers.length > 0 && Math.random() < 0.7) {
                const suspiciousId = suspiciousPlayers[Math.floor(Math.random() * suspiciousPlayers.length)];
                targetPlayer = players.find(p => p.id === suspiciousId);
            }
            
            // å¦‚æœæ²¡æœ‰å¯ç–‘ç©å®¶æˆ–éšæœºé€‰æ‹©äº†å…¶ä»–äºº
            if (!targetPlayer && alivePlayers.length > 0) {
                targetPlayer = alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
            }
            
            let statement = "";
            
            // æ·»åŠ é—®å€™
            statement += generic.greeting[Math.floor(Math.random() * generic.greeting.length)].replace('{name}', aiPlayer.name);
            statement += " ";
            
            // å¦‚æœå†³å®šé€éœ²èº«ä»½
            if (willReveal) {
                switch(role) {
                    case 'villager':
                        statement += templates.claim[Math.floor(Math.random() * templates.claim.length)];
                        break;
                    case 'seer':
                        if (aiPlayer.seerResults && aiPlayer.seerResults.length > 0) {
                            const lastResult = aiPlayer.seerResults[aiPlayer.seerResults.length - 1];
                            statement += templates.claim[Math.floor(Math.random() * templates.claim.length)]
                                .replace('{target}', lastResult.playerName)
                                .replace('{result}', lastResult.isWolf ? 'ç‹¼äºº' : 'å¥½äºº');
                        } else {
                            statement += templates.claim[0]
                                .replace('{target}', targetPlayer ? targetPlayer.name : 'æŸäºº')
                                .replace('{result}', 'å¥½äºº'); // é»˜è®¤å£°ç§°æŸ¥åˆ°å¥½äºº
                        }
                        break;
                    case 'witch':
                        let action = 'è¿˜æ²¡æœ‰ä½¿ç”¨ä»»ä½•è¯';
                        if (aiPlayer.witchSaveUsed) action = 'ç”¨äº†è§£è¯';
                        if (aiPlayer.witchPoisonUsed) action = 'ç”¨äº†æ¯’è¯';
                        if (aiPlayer.witchSaveUsed && aiPlayer.witchPoisonUsed) action = 'å·²ç»ç”¨å®Œäº†ä¸¤ç“¶è¯';
                        
                        statement += templates.claim[Math.floor(Math.random() * templates.claim.length)]
                            .replace('{action}', action);
                        break;
                    case 'hunter':
                    case 'guard':
                    case 'idiot':
                        statement += templates.claim[Math.floor(Math.random() * templates.claim.length)];
                        if (targetPlayer && role === 'guard') {
                            statement = statement.replace('{target}', targetPlayer.name);
                        }
                        break;
                }
                statement += " ";
            } else {
                // ä½¿ç”¨ä¸­æ€§å‘è¨€
                statement += generic.neutral[Math.floor(Math.random() * generic.neutral.length)];
                statement += " ";
            }
            
            // æ·»åŠ å¯¹æŸäººçš„æ€€ç–‘
            if (targetPlayer && Math.random() < personality.accusationThreshold) {
                let suspicion;
                if (role === 'villager') {
                    suspicion = templates.analysis[Math.floor(Math.random() * templates.analysis.length)];
                } else {
                    suspicion = generic.suspect[Math.floor(Math.random() * generic.suspect.length)];
                }
                statement += suspicion.replace('{target}', targetPlayer.name);
                statement += " ";
            }
            
            // å¦‚æœè¢«æ€€ç–‘ï¼Œæ·»åŠ é˜²å¾¡å‘è¨€
            if (aiPlayer.isAccused && Math.random() < personality.selfDefenseStrength) {
                statement += generic.defend[Math.floor(Math.random() * generic.defend.length)];
                statement += " ";
            }
            
            // æ·»åŠ ç‰¹å®šè§’è‰²çš„ç­–ç•¥å‘è¨€
            if (willReveal && role !== 'villager') {
                switch(role) {
                    case 'seer':
                        statement += templates.reasoning[Math.floor(Math.random() * templates.reasoning.length)];
                        statement += " ";
                        break;
                    case 'witch':
                        statement += templates.strategy[Math.floor(Math.random() * templates.strategy.length)];
                        statement += " ";
                        break;
                    case 'hunter':
                        if (targetPlayer) {
                            statement += templates.threat[Math.floor(Math.random() * templates.threat.length)]
                                .replace('{target}', targetPlayer.name);
                            statement += " ";
                        }
                        break;
                    case 'guard':
                        statement += templates.strategy[Math.floor(Math.random() * templates.strategy.length)];
                        statement += " ";
                        break;
                    case 'idiot':
                        if (targetPlayer && deadPlayers.includes(aiPlayer.id)) {
                            statement += templates.argument[Math.floor(Math.random() * templates.argument.length)]
                                .replace('{target}', targetPlayer.name);
                            statement += " ";
                        }
                        break;
                }
            }
            
            // æ·»åŠ ç»“æŸè¯­
            statement += generic.closing[Math.floor(Math.random() * generic.closing.length)];
            
            return statement;
        }

        function getAIStatement(aiPlayer) {
            // æ ¹æ®è§’è‰²å’Œæ€§æ ¼ç”Ÿæˆè¯­å¥
            if (['wolf', 'wolf-king', 'secret-wolf'].includes(aiPlayer.role)) {
                return getRandomWolfStatement(aiPlayer, gameState.players, gameState.deadPlayers);
            } else {
                return getRandomVillagerStatement(aiPlayer, gameState.players, gameState.deadPlayers, aiPlayer.role);
            }
        }

        function aiMakeDecision(aiPlayer, action) {
            // è®©AIåšå‡ºå†³ç­–ï¼ˆæŠ•ç¥¨ã€ä½¿ç”¨æŠ€èƒ½ç­‰ï¼‰
            const alivePlayers = gameState.players.filter(p => !gameState.deadPlayers.includes(p.id) && p.id !== aiPlayer.id);
            
            switch(action) {
                case 'vote':
                    // AIæŠ•ç¥¨é€»è¾‘
                    let voteTarget = null;
                    
                    // ç‹¼äººå€¾å‘äºæŠ•å¥½äºº
                    if (['wolf', 'wolf-king', 'secret-wolf'].includes(aiPlayer.role)) {
                        const goodPlayers = alivePlayers.filter(p => 
                            !['wolf', 'wolf-king', 'secret-wolf'].includes(p.role)
                        );
                        
                        if (goodPlayers.length > 0) {
                            voteTarget = goodPlayers[Math.floor(Math.random() * goodPlayers.length)].id;
                        }
                    } 
                    // å¥½äººå€¾å‘äºæŠ•å¯ç–‘çš„äºº
                    else {
                        // å¦‚æœAIæœ‰æ€€ç–‘åˆ—è¡¨ï¼Œä»ä¸­é€‰æ‹©
                        if (aiPlayer.suspicions && aiPlayer.suspicions.length > 0) {
                            const suspiciousId = aiPlayer.suspicions[Math.floor(Math.random() * aiPlayer.suspicions.length)];
                            // ç¡®ä¿æ€€ç–‘çš„ç©å®¶è¿˜æ´»ç€
                            const suspiciousPlayer = alivePlayers.find(p => p.id === suspiciousId);
                            if (suspiciousPlayer) {
                                voteTarget = suspiciousPlayer.id;
                            }
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
                    if (!voteTarget && alivePlayers.length > 0) {
                        voteTarget = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
                    }
                    
                    return voteTarget;
                
                case 'wolf_kill':
                    // ç‹¼äººæ€äººé€»è¾‘
                    if (['wolf', 'wolf-king', 'secret-wolf'].includes(aiPlayer.role)) {
                        const goodPlayers = alivePlayers.filter(p => 
                            !['wolf', 'wolf-king', 'secret-wolf'].includes(p.role)
                        );
                        
                        if (goodPlayers.length > 0) {
                            // ä¼˜å…ˆå‡»æ€ç‰¹æ®Šè§’è‰²æˆ–æ˜ç¡®çš„å¨èƒ
                            const specialRoles = goodPlayers.filter(p => 
                                ['seer', 'witch', 'hunter'].includes(p.role)
                            );
                            
                            if (specialRoles.length > 0) {
                                return specialRoles[Math.floor(Math.random() * specialRoles.length)].id;
                            } else {
                                return goodPlayers[Math.floor(Math.random() * goodPlayers.length)].id;
                            }
                        }
                    }
                    break;
                
                case 'witch_save':
                    // å¥³å·«æ•‘äººé€»è¾‘
                    if (aiPlayer.role === 'witch' && !aiPlayer.witchSaveUsed) {
                        // 60%çš„æ¦‚ç‡æ•‘äºº
                        return Math.random() < 0.6;
                    }
                    return false;
                
                case 'witch_poison':
                    // å¥³å·«æ¯’äººé€»è¾‘
                    if (aiPlayer.role === 'witch' && !aiPlayer.witchPoisonUsed) {
                        // ç‹¼äººé¦–é€‰ï¼Œç„¶åæ˜¯å¯ç–‘ç©å®¶
                        const wolves = alivePlayers.filter(p => 
                            ['wolf', 'wolf-king', 'secret-wolf'].includes(p.role)
                        );
                        
                        if (wolves.length > 0 && Math.random() < 0.8) {
                            return wolves[Math.floor(Math.random() * wolves.length)].id;
                        } else if (aiPlayer.suspicions && aiPlayer.suspicions.length > 0) {
                            const suspiciousId = aiPlayer.suspicions[Math.floor(Math.random() * aiPlayer.suspicions.length)];
                            const suspiciousPlayer = alivePlayers.find(p => p.id === suspiciousId);
                            if (suspiciousPlayer) {
                                return suspiciousPlayer.id;
                            }
                        }
                    }
                    return null;
                
                case 'seer_check':
                    // é¢„è¨€å®¶æŸ¥éªŒé€»è¾‘
                    if (aiPlayer.role === 'seer') {
                        // æ²¡æœ‰æ€€ç–‘ç›®æ ‡æ—¶éšæœºæŸ¥éªŒ
                        if (!aiPlayer.suspicions || aiPlayer.suspicions.length === 0) {
                            return alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
                        } else {
                            // ä»æ€€ç–‘ç›®æ ‡ä¸­æŸ¥éªŒ
                            const suspiciousId = aiPlayer.suspicions[Math.floor(Math.random() * aiPlayer.suspicions.length)];
                            const suspiciousPlayer = alivePlayers.find(p => p.id === suspiciousId);
                            if (suspiciousPlayer) {
                                return suspiciousPlayer.id;
                            } else {
                                return alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
                            }
                        }
                    }
                    break;
                
                case 'guard_protect':
                    // å®ˆå«ä¿æŠ¤é€»è¾‘
                    if (aiPlayer.role === 'guard') {
                        // æ‰¾å‡ºæ´»ç€çš„ç‰¹æ®Šå¥½äººè§’è‰²
                        const specialGoodPlayers = alivePlayers.filter(p => 
                            ['seer', 'witch', 'hunter'].includes(p.role)
                        );
                        
                        let protectTarget = null;
                        
                        // ä¼˜å…ˆä¿æŠ¤ç‰¹æ®Šå¥½äºº
                        if (specialGoodPlayers.length > 0) {
                            protectTarget = specialGoodPlayers[Math.floor(Math.random() * specialGoodPlayers.length)].id;
                        } 
                        // éšæœºä¿æŠ¤ä¸€ä¸ªäºº
                        else if (alivePlayers.length > 0) {
                            protectTarget = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
                        }
                        
                        // ç¡®ä¿ä¸è¿ç»­ä¸¤æ™šä¿æŠ¤åŒä¸€ä¸ªäºº
                        if (protectTarget === aiPlayer.lastGuardTarget) {
                            const otherPlayers = alivePlayers.filter(p => p.id !== protectTarget);
                            if (otherPlayers.length > 0) {
                                protectTarget = otherPlayers[Math.floor(Math.random() * otherPlayers.length)].id;
                            }
                        }
                        
                        return protectTarget;
                    }
                    break;
                
                case 'hunter_shoot':
                case 'wolf_king_howl':
                    // çŒäººå¼€æªæˆ–ç‹¼ç‹å¸¦äººé€»è¾‘
                    if ((action === 'hunter_shoot' && aiPlayer.role === 'hunter') || 
                        (action === 'wolf_king_howl' && aiPlayer.role === 'wolf-king')) {
                        
                        if (action === 'hunter_shoot') {
                            // çŒäººå€¾å‘äºå°„æ€ç‹¼äººæˆ–å¯ç–‘ç©å®¶
                            const wolves = alivePlayers.filter(p => 
                                ['wolf', 'wolf-king', 'secret-wolf'].includes(p.role)
                            );
                            
                            if (wolves.length > 0 && Math.random() < 0.8) {
                                return wolves[Math.floor(Math.random() * wolves.length)].id;
                            }
                        } else {
                            // ç‹¼ç‹å€¾å‘äºå¸¦èµ°å¥½äººæˆ–å¨èƒ
                            const goodPlayers = alivePlayers.filter(p => 
                                !['wolf', 'wolf-king', 'secret-wolf'].includes(p.role)
                            );
                            
                            if (goodPlayers.length > 0) {
                                // ä¼˜å…ˆå¸¦èµ°ç‰¹æ®Šè§’è‰²
                                const specialRoles = goodPlayers.filter(p => 
                                    ['seer', 'witch', 'hunter'].includes(p.role)
                                );
                                
                                if (specialRoles.length > 0) {
                                    return specialRoles[Math.floor(Math.random() * specialRoles.length)].id;
                                } else {
                                    return goodPlayers[Math.floor(Math.random() * goodPlayers.length)].id;
                                }
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰ç‰¹å®šç›®æ ‡ï¼Œä»å¯ç–‘äººç‰©ä¸­é€‰æ‹©
                        if (aiPlayer.suspicions && aiPlayer.suspicions.length > 0) {
                            const suspiciousId = aiPlayer.suspicions[Math.floor(Math.random() * aiPlayer.suspicions.length)];
                            const suspiciousPlayer = alivePlayers.find(p => p.id === suspiciousId);
                            if (suspiciousPlayer) {
                                return suspiciousPlayer.id;
                            }
                        }
                        
                        // å¦åˆ™éšæœºé€‰æ‹©
                        if (alivePlayers.length > 0) {
                            return alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
                        }
                    }
                    break;
            }
            
            return null;
        }

        // åˆå§‹åŒ–P2Pè¿æ¥
        function initPeer() {
            return new Promise((resolve, reject) => {
                const peer = new Peer({
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', id => {
                    console.log('My peer ID is: ' + id);
                    gameState.peer = peer;
                    resolve(peer);
                });
                
                peer.on('error', err => {
                    console.error('Peer error:', err);
                    reject(err);
                });
                
                peer.on('connection', conn => {
                    handleNewConnection(conn);
                });
            });
        }

        function handleNewConnection(conn) {
            // ä¿å­˜è¿æ¥
            gameState.connections[conn.peer] = conn;
            
            conn.on('data', data => {
                handlePeerMessage(conn.peer, data);
            });
            
            conn.on('close', () => {
                // å¤„ç†ç©å®¶æ–­å¼€è¿æ¥
                console.log('Connection closed with peer:', conn.peer);
                delete gameState.connections[conn.peer];
                
                // å¦‚æœæ¸¸æˆå·²ç»å¼€å§‹ï¼Œå°†ç©å®¶æ ‡è®°ä¸ºç¦»çº¿ä½†ä¸ç§»é™¤
                if (gameState.gameStarted) {
                    const playerIndex = gameState.players.findIndex(p => p.id === conn.peer);
                    if (playerIndex !== -1) {
                        gameState.players[playerIndex].isOffline = true;
                        addToGameLog(`${gameState.players[playerIndex].name} å·²ç¦»çº¿`);
                        
                        // å¦‚æœæ˜¯æˆ¿ä¸»ç¦»çº¿ä¸”æ¸¸æˆå·²ç»å¼€å§‹ï¼Œå°è¯•å°†æˆ¿ä¸»è½¬ç§»
                        if (playerIndex === 0) {
                            const newHostIndex = gameState.players.findIndex(p => !p.isOffline && !p.isAI);
                            if (newHostIndex !== -1) {
                                const newHost = gameState.players[newHostIndex];
                                const oldHost = gameState.players[0];
                                
                                // äº¤æ¢ä½ç½®
                                gameState.players[0] = newHost;
                                gameState.players[newHostIndex] = oldHost;
                                
                                addToGameLog(`æˆ¿ä¸»å·²å˜æ›´ä¸º ${newHost.name}`);
                                
                                // å¹¿æ’­æˆ¿ä¸»å˜æ›´
                                broadcastGameState();
                            }
                        }
                    }
                } else {
                    // æ¸¸æˆæœªå¼€å§‹ï¼Œç›´æ¥ä»ç©å®¶åˆ—è¡¨ä¸­ç§»é™¤
                    gameState.players = gameState.players.filter(p => p.id !== conn.peer);
                    updatePlayerList();
                    
                    // å¹¿æ’­ç©å®¶åˆ—è¡¨æ›´æ–°
                    broadcastGameState();
                }
            });
            
            conn.on('error', err => {
                console.error('Connection error:', err);
            });
        }

        function createRoom() {
            const playerName = document.getElementById('player-name-create').value.trim();
            
            if (!playerName) {
                alert('è¯·è¾“å…¥ä½ çš„åå­—');
                return;
            }
            
            gameState.playerName = playerName;
            gameState.roomCode = generateRoomCode();
            gameState.isHost = true;
            
            // æ·»åŠ è‡ªå·±åˆ°ç©å®¶åˆ—è¡¨
            gameState.players.push({
                id: gameState.peer.id,
                name: playerName,
                isHost: true,
                isAI: false
            });
            
            // æ˜¾ç¤ºæˆ¿é—´ä»£ç 
            document.getElementById('display-room-code').textContent = gameState.roomCode;
            document.getElementById('waiting-room-code').textContent = gameState.roomCode;
            document.getElementById('waiting-host-name').textContent = playerName;
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨å¹¶åˆ‡æ¢åˆ°æˆ¿é—´è®¾ç½®å±å¹•
            updatePlayerList();
            showScreen('room-setup-screen');
        }

        async function joinRoom() {
            const playerName = document.getElementById('player-name-join').value.trim();
            const roomCode = document.getElementById('room-code').value.trim().toUpperCase();
            
            if (!playerName) {
                alert('è¯·è¾“å…¥ä½ çš„åå­—');
                return;
            }
            
            if (!roomCode) {
                alert('è¯·è¾“å…¥æˆ¿é—´ä»£ç ');
                return;
            }
            
            gameState.playerName = playerName;
            gameState.roomCode = roomCode;
            gameState.isHost = false;
            
            try {
                // æ˜¾ç¤ºç­‰å¾…ç•Œé¢
                showScreen('waiting-screen');
                document.getElementById('waiting-room-code').textContent = roomCode;
                
                // å‘æˆ¿ä¸»å‘é€è¿æ¥è¯·æ±‚
                await window.Poe.sendUserMessage("@Claude-3.7-Sonnet è¯·ç­‰å¾…å…¶ä»–çœŸå®ç©å®¶é€šè¿‡P2Pè¿æ¥åˆ°æ­¤æˆ¿é—´ã€‚å½“ç©å®¶ç‚¹å‡»'åŠ å…¥æˆ¿é—´'æŒ‰é’®æ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é€šè¿‡P2Pç½‘ç»œå»ºç«‹è¿æ¥ã€‚", {
                    stream: true,
                    openChat: false
                });
                
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ éœ€è¦ä¸€ä¸ªä¿¡ä»¤æœåŠ¡å™¨æ¥åŒ¹é…æˆ¿é—´ä»£ç å’ŒPeer ID
                // è¿™é‡Œæˆ‘ä»¬å‡è®¾æˆ¿é—´ä»£ç æ˜ å°„åˆ°æŸä¸ªå‡½æ•°è°ƒç”¨ï¼Œæš‚æ—¶ä½¿ç”¨ä¸€ä¸ªå¸¸è§„å‡½æ•°æ¨¡æ‹Ÿ
                requestToJoinRoom(roomCode, gameState.peer.id, playerName);
            } catch (error) {
                console.error('åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
                alert('åŠ å…¥æˆ¿é—´å¤±è´¥: ' + error.message);
                showScreen('welcome-screen');
            }
        }

        // æ¨¡æ‹ŸåŠ å…¥æˆ¿é—´çš„è¯·æ±‚å¤„ç†
        function requestToJoinRoom(roomCode, peerId, playerName) {
            // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
            const waitingList = document.getElementById('waiting-player-list');
            waitingList.innerHTML = '<li class="py-3">æ­£åœ¨è¿æ¥æˆ¿é—´ï¼Œè¯·ç¨å€™...</li>';
            
            // å‡è®¾å¯¹æ–¹çš„IDæ˜¯æˆ¿é—´å·çš„å“ˆå¸Œå€¼(åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸ªIDåº”è¯¥ä»ä¿¡ä»¤æœåŠ¡å™¨è·å–)
            // åœ¨è¿™ä¸ªdemoä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå‡è®¾çš„è¿æ¥æ–¹å¼
            // æ­¤å¤„éœ€è¦æ¢æˆçœŸå®çš„è¿æ¥é€»è¾‘
            try {
                // éšæœºç”Ÿæˆä¸€ä¸ªå‡çš„Host ID (åœ¨å®é™…åº”ç”¨ä¸­ä¸è¦è¿™æ ·åš)
                const fakeHostId = "host_" + roomCode.toLowerCase();
                
                // è¿æ¥åˆ°å‡ä¸»æœº
                connectToHost(fakeHostId, playerName);
                
                // ç”±äºè¿™æ˜¯ä¸€ä¸ªå‡è®¾çš„è¿æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€äº›æ¨¡æ‹Ÿçš„å»¶è¿Ÿå’ŒUIæ›´æ–°
                setTimeout(() => {
                    addAIPlayers(3); // æ·»åŠ ä¸€äº›AIç©å®¶ä»¥æ¼”ç¤º
                    updateWaitingPlayerList();
                }, 1000);
            } catch (error) {
                console.error('è¿æ¥æˆ¿ä¸»å¤±è´¥:', error);
                waitingList.innerHTML = '<li class="py-3 text-red-500">è¿æ¥æˆ¿ä¸»å¤±è´¥ï¼Œè¯·æ£€æŸ¥æˆ¿é—´ä»£ç æ˜¯å¦æ­£ç¡®</li>';
                
                // 3ç§’åè¿”å›æ¬¢è¿å±å¹•
                setTimeout(() => showScreen('welcome-screen'), 3000);
            }
        }

        function connectToHost(hostId, playerName) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ­¤å‡½æ•°ä¼šä½¿ç”¨PeerJSè¿æ¥åˆ°æˆ¿ä¸»
            console.log(`å°è¯•è¿æ¥åˆ°æˆ¿ä¸» ${hostId} ä½œä¸º ${playerName}`);
            
            // æ¨¡æ‹Ÿè¿æ¥æˆåŠŸ
            simulateJoinSuccess(playerName);
        }

        function simulateJoinSuccess(playerName) {
            // æ¨¡æ‹Ÿè¿æ¥åˆ°æˆ¿é—´æˆåŠŸ
            gameState.players = [
                { id: "host_id", name: "æˆ¿ä¸»", isHost: true, isAI: false },
                { id: gameState.peer.id, name: playerName, isHost: false, isAI: false }
            ];
            
            document.getElementById('waiting-host-name').textContent = "æˆ¿ä¸»";
            updateWaitingPlayerList();
        }

        function updateWaitingPlayerList() {
            const waitingList = document.getElementById('waiting-player-list');
            waitingList.innerHTML = '';
            
            gameState.players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'py-3 flex items-center';
                
                const isAI = player.isAI;
                const isYou = player.id === gameState.peer.id;
                const isHost = player.isHost;
                
                let nameDisplay = player.name;
                if (isYou) nameDisplay += ' (ä½ )';
                if (isHost) nameDisplay = 'æˆ¿ä¸» ' + nameDisplay;
                if (isAI) nameDisplay += ' [AI]';
                
                li.innerHTML = `
                    <span class="inline-block h-8 w-8 rounded-full ${isAI ? 'bg-green-500' : 'bg-primary'} text-white flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                    </span>
                    <span class="font-medium">${nameDisplay}</span>
                `;
                waitingList.appendChild(li);
            });
        }

        // æ·»åŠ AIç©å®¶
        function showAddAIModal() {
            // éšæœºç”Ÿæˆä¸€ä¸ªåå­—
            const aiNames = ['å°æ˜', 'å°çº¢', 'å°åˆš', 'å°ä¸½', 'å°å', 'å°èŠ³', 'å°ä¸œ', 'å°è¥¿', 'å°å—', 'å°åŒ—'];
            const randomName = aiNames[Math.floor(Math.random() * aiNames.length)] + Math.floor(Math.random() * 100);
            
            document.getElementById('ai-player-name').value = randomName;
            document.getElementById('ai-player-personality').value = 'random';
            
            showModal('add-ai-modal');
        }

        function addAIPlayer() {
            const aiName = document.getElementById('ai-player-name').value.trim();
            let aiPersonality = document.getElementById('ai-player-personality').value;
            
            if (!aiName) {
                alert('è¯·è¾“å…¥AIç©å®¶åå­—');
                return;
            }
            
            // å¦‚æœé€‰æ‹©éšæœºæ€§æ ¼ï¼Œä»ç°æœ‰æ€§æ ¼ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            if (aiPersonality === 'random') {
                const personalities = Object.keys(AI_PERSONALITIES);
                aiPersonality = personalities[Math.floor(Math.random() * personalities.length)];
            }
            
            // ç”Ÿæˆå”¯ä¸€ID
            const aiId = 'ai_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            // æ·»åŠ AIç©å®¶åˆ°ç©å®¶åˆ—è¡¨
            gameState.players.push({
                id: aiId,
                name: aiName,
                isHost: false,
                isAI: true,
                personality: aiPersonality,
                suspicions: []  // AIçš„æ€€ç–‘ç›®æ ‡åˆ—è¡¨
            });
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨å¹¶éšè—å¼¹çª—
            updatePlayerList();
            hideModal('add-ai-modal');
            
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œå¹¿æ’­ç©å®¶åˆ—è¡¨æ›´æ–°
            if (gameState.isHost) {
                broadcastGameState();
            }
        }

        // ç”¨äºæ¼”ç¤ºçš„æ·»åŠ å¤šä¸ªAIç©å®¶
        function addAIPlayers(count) {
            const aiNames = ['å°æ˜', 'å°çº¢', 'å°åˆš', 'å°ä¸½', 'å°å', 'å°èŠ³', 'å°ä¸œ', 'å°è¥¿', 'å°å—', 'å°åŒ—'];
            const personalities = Object.keys(AI_PERSONALITIES);
            
            for (let i = 0; i < count; i++) {
                const aiName = aiNames[Math.floor(Math.random() * aiNames.length)] + Math.floor(Math.random() * 100);
                const aiPersonality = personalities[Math.floor(Math.random() * personalities.length)];
                const aiId = 'ai_' + Date.now() + '_' + i;
                
                gameState.players.push({
                    id: aiId,
                    name: aiName,
                    isHost: false,
                    isAI: true,
                    personality: aiPersonality,
                    suspicions: []
                });
            }
        }

        // å¹¿æ’­æ¸¸æˆçŠ¶æ€ç»™æ‰€æœ‰è¿æ¥çš„ç©å®¶
        function broadcastGameState() {
            Object.values(gameState.connections).forEach(conn => {
                conn.send({
                    type: 'game_state',
                    state: {
                        players: gameState.players,
                        roleSettings: gameState.roleSettings,
                        gamePhase: gameState.gamePhase,
                        day: gameState.day,
                        roomCode: gameState.roomCode,
                        gameStarted: gameState.gameStarted
                    }
                });
            });
        }

        // å‘ç‰¹å®šç©å®¶å‘é€ç§å¯†ä¿¡æ¯
        function sendPrivateInfo(peerId, type, data) {
            const conn = gameState.connections[peerId];
            if (conn) {
                conn.send({
                    type: type,
                    data: data
                });
            }
        }

        // å¤„ç†æ”¶åˆ°çš„P2Pæ¶ˆæ¯
        function handlePeerMessage(peerId, message) {
            console.log('Received message:', message);
            
            switch (message.type) {
                case 'join_request':
                    // å¤„ç†åŠ å…¥è¯·æ±‚
                    if (gameState.isHost && !gameState.gameStarted) {
                        // æ£€æŸ¥åå­—æ˜¯å¦å·²å­˜åœ¨
                        const nameExists = gameState.players.some(p => p.name === message.playerName);
                        
                        if (nameExists) {
                            sendPrivateInfo(peerId, 'join_response', {
                                accepted: false,
                                reason: 'è¯¥åå­—å·²è¢«ä½¿ç”¨'
                            });
                        } else {
                            // æ¥å—è¯·æ±‚
                            gameState.players.push({
                                id: peerId,
                                name: message.playerName,
                                isHost: false,
                                isAI: false
                            });
                            
                            sendPrivateInfo(peerId, 'join_response', {
                                accepted: true,
                                state: {
                                    players: gameState.players,
                                    roleSettings: gameState.roleSettings,
                                    gamePhase: gameState.gamePhase,
                                    roomCode: gameState.roomCode,
                                    host: gameState.players[0].name
                                }
                            });
                            
                            // æ›´æ–°ç©å®¶åˆ—è¡¨å¹¶å¹¿æ’­æ–°çŠ¶æ€
                            updatePlayerList();
                            broadcastGameState();
                        }
                    } else {
                        // æ¸¸æˆå·²å¼€å§‹ï¼Œæ‹’ç»è¯·æ±‚
                        sendPrivateInfo(peerId, 'join_response', {
                            accepted: false,
                            reason: 'æ¸¸æˆå·²ç»å¼€å§‹'
                        });
                    }
                    break;
                
                case 'join_response':
                    // å¤„ç†åŠ å…¥å“åº”
                    if (message.accepted) {
                        // æ›´æ–°æœ¬åœ°æ¸¸æˆçŠ¶æ€
                        Object.assign(gameState, message.state);
                        
                        // æ›´æ–°ç­‰å¾…å±å¹•
                        document.getElementById('waiting-host-name').textContent = message.state.host;
                        updateWaitingPlayerList();
                    } else {
                        alert('åŠ å…¥æˆ¿é—´å¤±è´¥: ' + message.reason);
                        showScreen('welcome-screen');
                    }
                    break;
                
                case 'game_state':
                    // æ›´æ–°æ¸¸æˆçŠ¶æ€
                    Object.assign(gameState, message.state);
                    
                    // æ›´æ–°UI
                    if (gameState.gameStarted && !gameState.inited) {
                        initializeGame();
                    } else {
                        updatePlayerList();
                    }
                    break;
                
                case 'start_game':
                    // å¤„ç†æ¸¸æˆå¼€å§‹
                    gameState.gameStarted = true;
                    gameState.playerRole = message.role;
                    
                    // åˆå§‹åŒ–æ¸¸æˆ
                    initializeGame();
                    break;
                
                case 'chat_message':
                    // æ·»åŠ èŠå¤©æ¶ˆæ¯
                    addChatMessage(message.playerName, message.text, message.playerId);
                    break;
                
                case 'game_action':
                    // å¤„ç†æ¸¸æˆåŠ¨ä½œ
                    handleGameAction(message.action, message.data);
                    break;
                
                case 'game_log':
                    // æ·»åŠ æ¸¸æˆæ—¥å¿—
                    addToGameLog(message.text);
                    break;
                
                case 'kick':
                    // è¢«è¸¢å‡ºæˆ¿é—´
                    alert(message.message || 'ä½ å·²è¢«æˆ¿ä¸»ç§»å‡ºæˆ¿é—´');
                    leaveRoom();
                    break;
            }
        }

        // å¤„ç†æ¸¸æˆåŠ¨ä½œ
        function handleGameAction(action, data) {
            switch (action) {
                case 'next_phase':
                    // è¿›å…¥ä¸‹ä¸€ä¸ªæ¸¸æˆé˜¶æ®µ
                    gameState.gamePhase = data.phase;
                    gameState.currentTurn = data.turn;
                    updateGamePhaseUI();
                    
                    if (data.phase === 'day_discussion') {
                        startDayPhase(data.day);
                    } else if (data.phase === 'night') {
                        startNightPhase();
                    } else if (data.phase === 'voting') {
                        startVotingPhase();
                    } else if (data.phase === 'speaking') {
                        startSpeakingPhase(data.speakingQueue);
                    }
                    break;
                
                case 'vote_result':
                    // æŠ•ç¥¨ç»“æœ
                    processVoteResult(data);
                    break;
                
                case 'night_result':
                    // å¤œæ™šç»“æœ
                    processNightResult(data);
                    break;
                
                case 'player_death':
                    // ç©å®¶æ­»äº¡
                    markPlayerDead(data.playerId, data.reason);
                    break;
                
                case 'game_over':
                    // æ¸¸æˆç»“æŸ
                    endGame(data.winner, data.roles);
                    break;
                
                case 'next_speaker':
                    // ä¸‹ä¸€ä¸ªå‘è¨€äºº
                    updateSpeaker(data.speakerId);
                    break;
                
                case 'special_ability_result':
                    // ç‰¹æ®Šèƒ½åŠ›ç»“æœ
                    processSpecialAbilityResult(data);
                    break;
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            // æ£€æŸ¥è§’è‰²é…ç½®æ˜¯å¦æ­£ç¡®
            updateRoleSettings();
            const totalRoles = calculateTotalRoles();
            const requiredPlayers = parseInt(document.getElementById('player-count').value);
            
            if (totalRoles !== requiredPlayers) {
                alert(`è§’è‰²é…ç½®é”™è¯¯ï¼šé…ç½®äº† ${totalRoles} ä¸ªè§’è‰²ï¼Œä½†éœ€è¦ ${requiredPlayers} ä¸ªç©å®¶`);
                return;
            }
            
            // æ£€æŸ¥ç©å®¶æ•°é‡æ˜¯å¦è¶³å¤Ÿ
            if (gameState.players.length < requiredPlayers) {
                alert(`ç©å®¶ä¸è¶³ï¼šéœ€è¦ ${requiredPlayers} åç©å®¶ï¼Œå½“å‰åªæœ‰ ${gameState.players.length} å`);
                return;
            }
            
            // åˆ†é…è§’è‰²
            const roles = assignRoles();
            gameState.gameStarted = true;
            gameState.gamePhase = 'night';
            gameState.day = 1;
            
            // ç»™æ¯ä¸ªç©å®¶å‘é€è§’è‰²ä¿¡æ¯
            roles.forEach(role => {
                if (role.id === gameState.peer.id) {
                    // è‡ªå·±çš„è§’è‰²
                    gameState.playerRole = role.role;
                } else if (!role.isAI) {
                    // å‘é€è§’è‰²ä¿¡æ¯ç»™å…¶ä»–çœŸå®ç©å®¶
                    sendPrivateInfo(role.id, 'start_game', { role: role.role });
                }
            });
            
            // å¹¿æ’­æ¸¸æˆå¼€å§‹
            broadcastGameState();
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initializeGame();
            
            // å¼€å§‹ç¬¬ä¸€ä¸ªå¤œæ™š
            setTimeout(() => {
                startNightPhase();
            }, 2000);
        }

        // åˆ†é…è§’è‰²
        function assignRoles() {
            // æ ¹æ®è§’è‰²è®¾ç½®åˆ›å»ºè§’è‰²æ± 
            const rolePool = [];
            
            for (const [roleId, count] of Object.entries(gameState.roleSettings)) {
                for (let i = 0; i < count; i++) {
                    rolePool.push(roleId);
                }
            }
            
            // æ‰“ä¹±è§’è‰²æ± 
            for (let i = rolePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rolePool[i], rolePool[j]] = [rolePool[j], rolePool[i]];
            }
            
            // åˆ†é…è§’è‰²ç»™ç©å®¶
            const roles = [];
            
            gameState.players.forEach((player, index) => {
                const role = rolePool[index];
                roles.push({
                    id: player.id,
                    name: player.name,
                    isAI: player.isAI,
                    personality: player.personality,
                    role: role
                });
                
                // å¦‚æœæ˜¯AIç©å®¶ï¼Œå­˜å‚¨å…¶è§’è‰²ä¿¡æ¯
                if (player.isAI) {
                    const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === player.id);
                    if (aiIndex !== -1) {
                        gameState.aiPlayers[aiIndex].role = role;
                    } else {
                        gameState.aiPlayers.push({
                            id: player.id,
                            name: player.name,
                            role: role,
                            personality: player.personality,
                            suspicions: []
                        });
                    }
                }
            });
            
            return roles;
        }

        // åˆå§‹åŒ–æ¸¸æˆç•Œé¢
        function initializeGame() {
            gameState.inited = true;
            
            // æ˜¾ç¤ºæ¸¸æˆå±å¹•
            showScreen('game-screen');
            
            // æ›´æ–°è§’è‰²ä¿¡æ¯
            updateRoleInfo();
            
            // æ›´æ–°ç©å®¶çŠ¶æ€ç½‘æ ¼
            updatePlayerStatusGrid();
            
            // æ¸…ç©ºæ¸¸æˆæ—¥å¿—å’ŒèŠå¤©
            document.getElementById('game-log').innerHTML = '<p>æ¸¸æˆå¼€å§‹ï¼</p>';
            document.getElementById('chat-messages').innerHTML = '';
            
            // æ›´æ–°æ¸¸æˆé˜¶æ®µæ˜¾ç¤º
            updateGamePhaseUI();
        }

        // æ›´æ–°è§’è‰²ä¿¡æ¯
        function updateRoleInfo() {
            if (!gameState.playerRole) return;
            
            const roleIcon = document.getElementById('role-icon');
            const roleName = document.getElementById('role-name');
            const roleTeam = document.getElementById('role-team');
            const roleDescription = document.getElementById('role-description');
            
            roleIcon.textContent = ROLE_ICONS[gameState.playerRole];
            roleName.textContent = ROLE_NAMES[gameState.playerRole];
            roleTeam.textContent = 'é˜µè¥ï¼š' + ROLE_TEAMS[gameState.playerRole];
            
            // è®¾ç½®è§’è‰²æè¿°
            roleDescription.querySelector('p').textContent = ROLE_DESCRIPTIONS[gameState.playerRole];
            
            // æ ¹æ®è§’è‰²ç±»å‹è®¾ç½®å¡ç‰‡èƒŒæ™¯é¢œè‰²
            const roleCard = document.querySelector('.role-card-back');
            if (['wolf', 'wolf-king', 'secret-wolf'].includes(gameState.playerRole)) {
                roleCard.classList.remove('bg-primary');
                roleCard.classList.add('bg-wolf');
            } else {
                roleCard.classList.remove('bg-wolf');
                roleCard.classList.add('bg-primary');
            }
        }

        // æ›´æ–°ç©å®¶çŠ¶æ€ç½‘æ ¼
        function updatePlayerStatusGrid() {
            const grid = document.getElementById('player-status-grid');
            grid.innerHTML = '';
            
            gameState.players.forEach(player => {
                const isAlive = !gameState.deadPlayers.includes(player.id);
                const isYou = player.id === gameState.peer.id;
                
                const playerCard = document.createElement('div');
                playerCard.className = `p-3 border rounded-lg ${isAlive ? 'bg-white dark:bg-gray-800' : 'bg-gray-200 dark:bg-gray-700'} ${isYou ? 'border-primary dark:border-primary' : 'border-gray-200 dark:border-gray-700'}`;
                
                playerCard.innerHTML = `
                    <div class="text-center mb-1">
                        <span class="inline-block h-8 w-8 rounded-full ${player.isAI ? 'bg-green-500' : 'bg-primary'} text-white flex items-center justify-center mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </span>
                    </div>
                    <div class="text-center">
                        <p class="font-medium truncate">${player.name}${isYou ? ' (ä½ )' : ''}</p>
                        <p class="text-xs ${isAlive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${isAlive ? 'å­˜æ´»' : 'æ­»äº¡'}</p>
                    </div>
                `;
                
                grid.appendChild(playerCard);
            });
        }

        // æ›´æ–°æ¸¸æˆé˜¶æ®µæ˜¾ç¤º
        function updateGamePhaseUI() {
            const phaseIndicator = document.getElementById('game-phase-indicator');
            const chatStatus = document.getElementById('chat-status');
            
            switch (gameState.gamePhase) {
                case 'waiting':
                    phaseIndicator.textContent = 'ç­‰å¾…ä¸­';
                    phaseIndicator.className = 'ml-2 text-sm font-normal px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    chatStatus.textContent = 'ç­‰å¾…æ¸¸æˆå¼€å§‹';
                    chatStatus.className = 'ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    break;
                case 'night':
                    phaseIndicator.textContent = `ç¬¬${gameState.day}å¤© å¤œæ™š`;
                    phaseIndicator.className = 'ml-2 text-sm font-normal px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200';
                    chatStatus.textContent = 'å¤œæ™šç¦è¨€';
                    chatStatus.className = 'ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    
                    // å¯ç”¨å¤œæ™šUI
                    document.getElementById('night-overlay').classList.remove('hidden');
                    document.getElementById('chat-input').disabled = true;
                    document.getElementById('send-chat-btn').disabled = true;
                    break;
                case 'day_discussion':
                case 'speaking':
                    phaseIndicator.textContent = `ç¬¬${gameState.day}å¤© ç™½å¤©`;
                    phaseIndicator.className = 'ml-2 text-sm font-normal px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    chatStatus.textContent = 'ç™½å¤©å¯å‘è¨€';
                    chatStatus.className = 'ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    
                    // ç¦ç”¨å¤œæ™šUI
                    document.getElementById('night-overlay').classList.add('hidden');
                    
                    // å¦‚æœç©å®¶æ´»ç€ï¼Œå…è®¸èŠå¤©
                    const isPlayerAlive = !gameState.deadPlayers.includes(gameState.peer.id);
                    document.getElementById('chat-input').disabled = !isPlayerAlive;
                    document.getElementById('send-chat-btn').disabled = !isPlayerAlive;
                    break;
                case 'voting':
                    phaseIndicator.textContent = `ç¬¬${gameState.day}å¤© æŠ•ç¥¨`;
                    phaseIndicator.className = 'ml-2 text-sm font-normal px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
                    chatStatus.textContent = 'æŠ•ç¥¨ä¸­';
                    chatStatus.className = 'ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';
                    
                    // ç¦ç”¨å¤œæ™šUI
                    document.getElementById('night-overlay').classList.add('hidden');
                    
                    // ç¦ç”¨èŠå¤©
                    document.getElementById('chat-input').disabled = true;
                    document.getElementById('send-chat-btn').disabled = true;
                    break;
                case 'game_over':
                    phaseIndicator.textContent = 'æ¸¸æˆç»“æŸ';
                    phaseIndicator.className = 'ml-2 text-sm font-normal px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                    chatStatus.textContent = 'æ¸¸æˆå·²ç»“æŸ';
                    chatStatus.className = 'ml-2 text-xs font-normal px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                    
                    // ç¦ç”¨å¤œæ™šUI
                    document.getElementById('night-overlay').classList.add('hidden');
                    
                    // ç¦ç”¨èŠå¤©
                    document.getElementById('chat-input').disabled = true;
                    document.getElementById('send-chat-btn').disabled = true;
                    break;
            }
        }

        // å¤œæ™šé˜¶æ®µ
        function startNightPhase() {
            gameState.gamePhase = 'night';
            updateGamePhaseUI();
            
            // éšè—ç™½å¤©çš„UIå…ƒç´ 
            document.getElementById('speaking-turn-indicator').classList.add('hidden');
            document.getElementById('vote-area').classList.add('hidden');
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            addToGameLog(`ç¬¬ ${gameState.day} å¤©çš„å¤œæ™šé™ä¸´äº†...`);
            
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œå¼€å§‹å¤„ç†å¤œæ™šé€»è¾‘
            if (gameState.isHost) {
                processNightPhase();
            }
        }

        // ç™½å¤©è®¨è®ºé˜¶æ®µ
        function startDayPhase(day) {
            gameState.gamePhase = 'day_discussion';
            gameState.day = day;
            updateGamePhaseUI();
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            addToGameLog(`ç¬¬ ${day} å¤©çš„ç™½å¤©åˆ°æ¥äº†...`);
            
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œå‡†å¤‡å‘è¨€ç¯èŠ‚
            if (gameState.isHost) {
                setTimeout(() => {
                    prepareSpeakingPhase();
                }, 2000);
            }
        }

        // å‡†å¤‡å‘è¨€ç¯èŠ‚
        function prepareSpeakingPhase() {
            // è·å–æ‰€æœ‰æ´»ç€çš„ç©å®¶
            const alivePlayers = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id)
            );
            
            // éšæœºæ’åºå‘è¨€é¡ºåº
            gameState.speakingQueue = [...alivePlayers].sort(() => Math.random() - 0.5).map(p => p.id);
            
            // å¹¿æ’­å‘è¨€ç¯èŠ‚å¼€å§‹
            Object.values(gameState.connections).forEach(conn => {
                conn.send({
                    type: 'game_action',
                    action: 'next_phase',
                    data: {
                        phase: 'speaking',
                        day: gameState.day,
                        speakingQueue: gameState.speakingQueue
                    }
                });
            });
            
            // æœ¬åœ°ä¹Ÿè¿›å…¥å‘è¨€ç¯èŠ‚
            startSpeakingPhase(gameState.speakingQueue);
        }

        // å‘è¨€ç¯èŠ‚
        function startSpeakingPhase(speakingQueue) {
            gameState.gamePhase = 'speaking';
            gameState.speakingQueue = speakingQueue;
            updateGamePhaseUI();
            
            // æ˜¾ç¤ºå‘è¨€è½®æ¬¡æŒ‡ç¤ºå™¨
            const speakingTurnIndicator = document.getElementById('speaking-turn-indicator');
            speakingTurnIndicator.classList.remove('hidden');
            
            // æ›´æ–°å‘è¨€é¡ºåºUI
            updateSpeakingOrderUI();
            
            // å¼€å§‹ç¬¬ä¸€ä¸ªå‘è¨€äºº
            if (gameState.isHost) {
                startNextSpeaker();
            }
        }

        // æ›´æ–°å‘è¨€é¡ºåºUI
        function updateSpeakingOrderUI() {
            const speakingOrder = document.getElementById('speaking-order');
            speakingOrder.innerHTML = '';
            
            gameState.speakingQueue.forEach(playerId => {
                const player = gameState.players.find(p => p.id === playerId);
                if (!player) return;
                
                const isCurrentSpeaker = playerId === gameState.currentSpeaker;
                
                const playerBadge = document.createElement('div');
                playerBadge.className = `px-3 py-1 rounded-full ${isCurrentSpeaker ? 'bg-primary text-white speaking-indicator' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'}`;
                playerBadge.textContent = player.name;
                
                if (player.id === gameState.peer.id) {
                    playerBadge.textContent += ' (ä½ )';
                }
                
                speakingOrder.appendChild(playerBadge);
            });
            
            // æ›´æ–°å‘è¨€æŒ‡ç¤ºæ–‡å­—
            const speakingInstruction = document.getElementById('speaking-instruction');
            const currentSpeaker = gameState.players.find(p => p.id === gameState.currentSpeaker);
            
            if (currentSpeaker) {
                if (currentSpeaker.id === gameState.peer.id) {
                    speakingInstruction.textContent = 'ç°åœ¨è½®åˆ°ä½ å‘è¨€ï¼Œè¯·åœ¨èŠå¤©æ¡†ä¸­è¾“å…¥ä½ çš„å‘è¨€ã€‚';
                } else {
                    speakingInstruction.textContent = `ç°åœ¨è½®åˆ° ${currentSpeaker.name} å‘è¨€ï¼Œè¯·ç­‰å¾…...`;
                }
            } else {
                speakingInstruction.textContent = 'å‡†å¤‡å¼€å§‹å‘è¨€ç¯èŠ‚...';
            }
            
            // æ›´æ–°"ä¸‹ä¸€ä½å‘è¨€"æŒ‰é’®
            const nextSpeakerBtn = document.getElementById('next-speaker-btn');
            if (gameState.isHost || gameState.currentSpeaker === gameState.peer.id) {
                nextSpeakerBtn.classList.remove('hidden');
            } else {
                nextSpeakerBtn.classList.add('hidden');
            }
        }

        // å¼€å§‹ä¸‹ä¸€ä½å‘è¨€è€…
        function startNextSpeaker() {
            // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿›å…¥æŠ•ç¥¨é˜¶æ®µ
            if (gameState.speakingQueue.length === 0) {
                if (gameState.isHost) {
                    startVotingPhase();
                }
                return;
            }
            
            // å–é˜Ÿåˆ—ç¬¬ä¸€ä¸ªäººä½œä¸ºå½“å‰å‘è¨€è€…
            gameState.currentSpeaker = gameState.speakingQueue.shift();
            
            // é‡ç½®å‘è¨€è®¡æ—¶å™¨
            gameState.speakingTimeLeft = 60;
            if (gameState.speakingTimer) {
                clearInterval(gameState.speakingTimer);
            }
            
            // å¹¿æ’­å½“å‰å‘è¨€è€…
            Object.values(gameState.connections).forEach(conn => {
                conn.send({
                    type: 'game_action',
                    action: 'next_speaker',
                    data: {
                        speakerId: gameState.currentSpeaker
                    }
                });
            });
            
            // æ›´æ–°å‘è¨€é¡ºåºUI
            updateSpeakingOrderUI();
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            const speaker = gameState.players.find(p => p.id === gameState.currentSpeaker);
            addToGameLog(`è½®åˆ° ${speaker.name} å‘è¨€äº†`);
            
            // å¼€å§‹è®¡æ—¶
            startSpeakingTimer();
            
            // å¦‚æœæ˜¯AIç©å®¶ï¼Œè‡ªåŠ¨å‘è¨€
            if (speaker && speaker.isAI) {
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œæ¨¡æ‹Ÿæ€è€ƒ
                setTimeout(() => {
                    const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === speaker.id);
                    if (aiIndex !== -1) {
                        const aiPlayer = gameState.aiPlayers[aiIndex];
                        const statement = getAIStatement(aiPlayer);
                        
                        // å‘é€AIçš„èŠå¤©æ¶ˆæ¯
                        broadcastChatMessage(aiPlayer.id, aiPlayer.name, statement);
                        
                        // éšæœºå»¶è¿Ÿåç»“æŸå‘è¨€
                        const speakingTime = 5000 + Math.random() * 5000;
                        setTimeout(() => {
                            if (gameState.isHost) {
                                endCurrentSpeech();
                            }
                        }, speakingTime);
                    }
                }, 1000 + Math.random() * 2000);
            }
        }

        // å¼€å§‹å‘è¨€è®¡æ—¶å™¨
        function startSpeakingTimer() {
            const timerDisplay = document.getElementById('speaking-time-left');
            timerDisplay.textContent = gameState.speakingTimeLeft;
            
            gameState.speakingTimer = setInterval(() => {
                gameState.speakingTimeLeft--;
                timerDisplay.textContent = gameState.speakingTimeLeft;
                
                if (gameState.speakingTimeLeft <= 0) {
                    clearInterval(gameState.speakingTimer);
                    
                    // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œç»“æŸå½“å‰å‘è¨€
                    if (gameState.isHost) {
                        endCurrentSpeech();
                    }
                }
            }, 1000);
        }

        // ç»“æŸå½“å‰å‘è¨€
        function endCurrentSpeech() {
            clearInterval(gameState.speakingTimer);
            
            // å¹¿æ’­å‘è¨€ç»“æŸ
            Object.values(gameState.connections).forEach(conn => {
                conn.send({
                    type: 'game_log',
                    text: 'å‘è¨€æ—¶é—´ç»“æŸ'
                });
            });
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            addToGameLog('å‘è¨€æ—¶é—´ç»“æŸ');
            
            // å¼€å§‹ä¸‹ä¸€ä½å‘è¨€è€…
            startNextSpeaker();
        }

        // æ›´æ–°å½“å‰å‘è¨€è€…
        function updateSpeaker(speakerId) {
            gameState.currentSpeaker = speakerId;
            updateSpeakingOrderUI();
            
            // å¦‚æœå½“å‰å‘è¨€è€…æ˜¯è‡ªå·±ï¼Œæ˜¾ç¤ºæç¤º
            if (speakerId === gameState.peer.id) {
                addToGameLog('ç°åœ¨è½®åˆ°ä½ å‘è¨€äº†', 'highlight');
            }
            
            // é‡ç½®å‘è¨€è®¡æ—¶å™¨
            gameState.speakingTimeLeft = 60;
            const timerDisplay = document.getElementById('speaking-time-left');
            timerDisplay.textContent = gameState.speakingTimeLeft;
            
            if (gameState.speakingTimer) {
                clearInterval(gameState.speakingTimer);
            }
            startSpeakingTimer();
        }

        // æŠ•ç¥¨é˜¶æ®µ
        function startVotingPhase() {
            gameState.gamePhase = 'voting';
            updateGamePhaseUI();
            
            // éšè—å‘è¨€è½®æ¬¡æŒ‡ç¤ºå™¨
            document.getElementById('speaking-turn-indicator').classList.add('hidden');
            
            // æ˜¾ç¤ºæŠ•ç¥¨åŒºåŸŸ
            const voteArea = document.getElementById('vote-area');
            voteArea.classList.remove('hidden');
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            addToGameLog('æŠ•ç¥¨ç¯èŠ‚å¼€å§‹ï¼Œè¯·é€‰æ‹©ä¸€åç©å®¶è¿›è¡ŒæŠ•ç¥¨æ”¾é€');
            
            // å¹¿æ’­æŠ•ç¥¨é˜¶æ®µå¼€å§‹
            if (gameState.isHost) {
                Object.values(gameState.connections).forEach(conn => {
                    conn.send({
                        type: 'game_action',
                        action: 'next_phase',
                        data: {
                            phase: 'voting',
                            day: gameState.day
                        }
                    });
                });
                
                // é‡ç½®æŠ•ç¥¨
                gameState.votes = {};
                
                // è®©AIç©å®¶è‡ªåŠ¨æŠ•ç¥¨
                processAIVotes();
            }
            
            // æ›´æ–°æŠ•ç¥¨é€‰é¡¹
            updateVoteOptions();
        }

        // æ›´æ–°æŠ•ç¥¨é€‰é¡¹
        function updateVoteOptions() {
            const voteOptions = document.getElementById('vote-options');
            voteOptions.innerHTML = '';
            
            // åªæ˜¾ç¤ºæ´»ç€çš„ç©å®¶
            const alivePlayers = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id)
            );
            
            alivePlayers.forEach(player => {
                const isYou = player.id === gameState.peer.id;
                
                const option = document.createElement('div');
                option.className = 'p-3 border rounded-lg bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary dark:hover:border-primary transition';
                option.setAttribute('data-player-id', player.id);
                
                option.innerHTML = `
                    <div class="text-center mb-1">
                        <span class="inline-block h-8 w-8 rounded-full ${player.isAI ? 'bg-green-500' : 'bg-primary'} text-white flex items-center justify-center mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </span>
                    </div>
                    <div class="text-center">
                        <p class="font-medium truncate">${player.name}${isYou ? ' (ä½ )' : ''}</p>
                    </div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                option.addEventListener('click', () => {
                    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                    document.querySelectorAll('#vote-options > div').forEach(el => {
                        el.classList.remove('border-primary', 'dark:border-primary');
                        el.classList.add('border-gray-200', 'dark:border-gray-700');
                    });
                    
                    // æ ‡è®°å½“å‰é€‰æ‹©
                    option.classList.remove('border-gray-200', 'dark:border-gray-700');
                    option.classList.add('border-primary', 'dark:border-primary');
                    
                    // ä¿å­˜é€‰æ‹©
                    gameState.selectedVoteTarget = player.id;
                });
                
                voteOptions.appendChild(option);
            });
            
            // æ£€æŸ¥ç©å®¶æ˜¯å¦æ´»ç€
            const isPlayerAlive = !gameState.deadPlayers.includes(gameState.peer.id);
            
            // ç¦ç”¨/å¯ç”¨æŠ•ç¥¨æŒ‰é’®
            document.getElementById('confirm-vote-btn').disabled = !isPlayerAlive;
            document.getElementById('skip-vote-btn').disabled = !isPlayerAlive;
            
            // ç™½ç—´è¢«æŠ•ç¥¨å‡ºå±€åå¯ä»¥è·³è¿‡æŠ•ç¥¨ä½†ä¸èƒ½æŠ•ç¥¨
            if (gameState.playerRole === 'idiot' && gameState.deadPlayers.includes(gameState.peer.id)) {
                document.getElementById('skip-vote-btn').disabled = false;
            }
        }

        // å¤„ç†AIæŠ•ç¥¨
        function processAIVotes() {
            // è·å–æ‰€æœ‰æ´»ç€çš„AIç©å®¶
            const aliveAIs = gameState.aiPlayers.filter(ai => !gameState.deadPlayers.includes(ai.id));
            
            // è®©AIç©å®¶é€ä¸ªè¿›è¡ŒæŠ•ç¥¨
            aliveAIs.forEach(ai => {
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œæ¨¡æ‹Ÿæ€è€ƒ
                setTimeout(() => {
                    const voteTarget = aiMakeDecision(ai, 'vote');
                    
                    if (voteTarget) {
                        // è®°å½•æŠ•ç¥¨
                        gameState.votes[ai.id] = voteTarget;
                        
                        // æ‰¾å‡ºç›®æ ‡ç©å®¶åç§°
                        const targetPlayer = gameState.players.find(p => p.id === voteTarget);
                        
                        // æ·»åŠ æ¸¸æˆæ—¥å¿—
                        addToGameLog(`${ai.name} æŠ•ç¥¨ç»™äº† ${targetPlayer ? targetPlayer.name : 'æœªçŸ¥ç©å®¶'}`);
                        broadcastGameLog(`${ai.name} æŠ•ç¥¨ç»™äº† ${targetPlayer ? targetPlayer.name : 'æœªçŸ¥ç©å®¶'}`);
                        
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ´»ç€çš„ç©å®¶éƒ½å·²æŠ•ç¥¨
                        checkAllVoted();
                    }
                }, 1000 + Math.random() * 3000);
            });
        }

        // æäº¤æŠ•ç¥¨
        function submitVote() {
            if (!gameState.selectedVoteTarget) {
                alert('è¯·é€‰æ‹©ä¸€åç©å®¶è¿›è¡ŒæŠ•ç¥¨');
                return;
            }
            
            // è®°å½•æŠ•ç¥¨
            gameState.votes[gameState.peer.id] = gameState.selectedVoteTarget;
            
            // æ‰¾å‡ºç›®æ ‡ç©å®¶åç§°
            const targetPlayer = gameState.players.find(p => p.id === gameState.selectedVoteTarget);
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            addToGameLog(`ä½ æŠ•ç¥¨ç»™äº† ${targetPlayer ? targetPlayer.name : 'æœªçŸ¥ç©å®¶'}`);
            
            // å‘é€æŠ•ç¥¨ç»™æˆ¿ä¸»
            if (!gameState.isHost) {
                const hostId = gameState.players.find(p => p.isHost)?.id;
                if (hostId && gameState.connections[hostId]) {
                    gameState.connections[hostId].send({
                        type: 'game_action',
                        action: 'vote',
                        data: {
                            voterId: gameState.peer.id,
                            targetId: gameState.selectedVoteTarget
                        }
                    });
                }
            } else {
                // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œå¹¿æ’­æŠ•ç¥¨ä¿¡æ¯
                broadcastGameLog(`${gameState.playerName} æŠ•ç¥¨ç»™äº† ${targetPlayer ? targetPlayer.name : 'æœªçŸ¥ç©å®¶'}`);
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ´»ç€çš„ç©å®¶éƒ½å·²æŠ•ç¥¨
                checkAllVoted();
            }
            
            // ç¦ç”¨æŠ•ç¥¨æŒ‰é’®
            document.getElementById('confirm-vote-btn').disabled = true;
            document.getElementById('skip-vote-btn').disabled = true;
        }

        // è·³è¿‡æŠ•ç¥¨
        function skipVote() {
            // è®°å½•å¼ƒæƒ
            gameState.votes[gameState.peer.id] = null;
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            addToGameLog('ä½ é€‰æ‹©å¼ƒæƒ');
            
            // å‘é€å¼ƒæƒç»™æˆ¿ä¸»
            if (!gameState.isHost) {
                const hostId = gameState.players.find(p => p.isHost)?.id;
                if (hostId && gameState.connections[hostId]) {
                    gameState.connections[hostId].send({
                        type: 'game_action',
                        action: 'vote',
                        data: {
                            voterId: gameState.peer.id,
                            targetId: null
                        }
                    });
                }
            } else {
                // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œå¹¿æ’­å¼ƒæƒä¿¡æ¯
                broadcastGameLog(`${gameState.playerName} é€‰æ‹©å¼ƒæƒ`);
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ´»ç€çš„ç©å®¶éƒ½å·²æŠ•ç¥¨
                checkAllVoted();
            }
            
            // ç¦ç”¨æŠ•ç¥¨æŒ‰é’®
            document.getElementById('confirm-vote-btn').disabled = true;
            document.getElementById('skip-vote-btn').disabled = true;
        }

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ´»ç€çš„ç©å®¶éƒ½å·²æŠ•ç¥¨
        function checkAllVoted() {
            if (!gameState.isHost) return;
            
            // è·å–æ‰€æœ‰æ´»ç€çš„ç©å®¶
            const alivePlayers = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id)
            );
            
            // ç™½ç—´è™½ç„¶"æ­»äº¡"ä½†ä»å¯ä»¥å‘è¨€ï¼Œä¸èƒ½æŠ•ç¥¨
            const canVotePlayers = alivePlayers.filter(player => {
                // å¦‚æœæ˜¯ç™½ç—´ä¸”å·²æ­»äº¡ï¼Œä¸èƒ½æŠ•ç¥¨
                if (player.role === 'idiot' && gameState.deadPlayers.includes(player.id)) {
                    return false;
                }
                return true;
            });
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¯æŠ•ç¥¨çš„ç©å®¶éƒ½å·²æŠ•ç¥¨
            const allVoted = canVotePlayers.every(player => 
                gameState.votes.hasOwnProperty(player.id)
            );
            
            if (allVoted) {
                // è®¡ç®—æŠ•ç¥¨ç»“æœ
                calculateVoteResult();
            }
        }

        // è®¡ç®—æŠ•ç¥¨ç»“æœ
        function calculateVoteResult() {
            // ç»Ÿè®¡ç¥¨æ•°
            const voteCounts = {};
            
            Object.entries(gameState.votes).forEach(([voterId, targetId]) => {
                // å¿½ç•¥å¼ƒæƒç¥¨
                if (targetId === null) return;
                
                if (!voteCounts[targetId]) {
                    voteCounts[targetId] = 0;
                }
                voteCounts[targetId]++;
            });
            
            // æ‰¾å‡ºç¥¨æ•°æœ€å¤šçš„ç©å®¶
            let maxVotes = 0;
            let votedOutPlayers = [];
            
            Object.entries(voteCounts).forEach(([playerId, votes]) => {
                if (votes > maxVotes) {
                    maxVotes = votes;
                    votedOutPlayers = [playerId];
                } else if (votes === maxVotes) {
                    votedOutPlayers.push(playerId);
                }
            });
            
            // å¦‚æœæœ‰å¹³ç¥¨ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
            let votedOutPlayer = null;
            if (votedOutPlayers.length > 0) {
                if (votedOutPlayers.length === 1) {
                    votedOutPlayer = votedOutPlayers[0];
                } else {
                    // å¹³ç¥¨éšæœº
                    votedOutPlayer = votedOutPlayers[Math.floor(Math.random() * votedOutPlayers.length)];
                }
            }
            
            // å¤„ç†æŠ•ç¥¨ç»“æœ
            if (votedOutPlayer) {
                processVotedOutPlayer(votedOutPlayer, voteCounts);
            } else {
                // æ²¡æœ‰äººè¢«æŠ•å‡ºï¼ˆå…¨éƒ¨å¼ƒæƒï¼‰
                broadcastGameLog('æ‰€æœ‰äººå‡å¼ƒæƒï¼Œæ²¡æœ‰äººè¢«æ”¾é€');
                
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (!checkGameEnd()) {
                    // è¿›å…¥å¤œæ™š
                    setTimeout(() => {
                        startNightPhase();
                    }, 3000);
                }
            }
        }

        // å¤„ç†è¢«æŠ•ç¥¨å‡ºå±€çš„ç©å®¶
        function processVotedOutPlayer(playerId, voteCounts) {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            
            // æ·»åŠ æ¸¸æˆæ—¥å¿—
            const voteCount = voteCounts[playerId];
            broadcastGameLog(`${player.name} è·å¾—äº†æœ€å¤šçš„ç¥¨æ•°(${voteCount}ç¥¨)ï¼Œè¢«æ‘æ°‘æ”¾é€`);
            
            // æ ‡è®°ç©å®¶æ­»äº¡
            markPlayerDead(playerId, 'voted');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Šè§’è‰²
            if (player.role === 'wolf-king') {
                // ç‹¼ç‹è¢«æŠ•å‡ºï¼Œå¯ä»¥å¸¦èµ°ä¸€ä¸ªäºº
                processWolfKingAbility(player);
            } else if (player.role === 'hunter') {
                // çŒäººè¢«æŠ•å‡ºï¼Œå¯ä»¥å¸¦èµ°ä¸€ä¸ªäºº
                processHunterAbility(player);
            } else if (player.role === 'idiot') {
                // ç™½ç—´è¢«æŠ•å‡ºï¼Œä¾ç„¶å¯ä»¥å‘è¨€ï¼Œä½†å¤±å»æŠ•ç¥¨æƒ
                broadcastGameLog(`${player.name} æ˜¯ç™½ç—´ï¼Œè¢«æ”¾é€åä»å¯ä»¥å‘è¨€ï¼Œä½†å¤±å»äº†æŠ•ç¥¨æƒ`);
                
                // ç‰¹æ®Šå¤„ç†ï¼šç™½ç—´ä¸ä¼šçœŸæ­£æ­»äº¡ï¼Œåªæ˜¯å¤±å»æŠ•ç¥¨æƒ
                gameState.deadPlayers = gameState.deadPlayers.filter(id => id !== playerId);
                gameState.spectators.push(playerId);
            }
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (!checkGameEnd()) {
                // è¿›å…¥å¤œæ™š
                setTimeout(() => {
                    startNightPhase();
                }, 3000);
            }
        }

        // å¤„ç†ç‹¼ç‹èƒ½åŠ›
        function processWolfKingAbility(player) {
            // æ ‡è®°ç‹¼ç‹æ­»äº¡
            gameState.wolfKingDead = true;
            
            // å¹¿æ’­ç‹¼ç‹èº«ä»½
            broadcastGameLog(`${player.name} æ˜¯ç‹¼ç‹ï¼æ­»å‰ä»–å¯ä»¥å¸¦èµ°ä¸€åç©å®¶...`);
            
            // å¦‚æœæ˜¯AIç‹¼ç‹
            if (player.isAI) {
                // AIåšå‡ºå†³ç­–
                const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === player.id);
                if (aiIndex !== -1) {
                    const aiPlayer = gameState.aiPlayers[aiIndex];
                    const targetId = aiMakeDecision(aiPlayer, 'wolf_king_howl');
                    
                    if (targetId) {
                        const targetPlayer = gameState.players.find(p => p.id === targetId);
                        if (targetPlayer) {
                            // å¹¿æ’­ç‹¼ç‹å¸¦èµ°ä¿¡æ¯
                            broadcastGameLog(`ç‹¼ç‹ ${player.name} åšå«ç€å¸¦èµ°äº† ${targetPlayer.name}ï¼`);
                            
                            // æ ‡è®°ç›®æ ‡ç©å®¶æ­»äº¡
                            markPlayerDead(targetId, 'wolf_king');
                        }
                    }
                }
            } 
            // å¦‚æœæ˜¯ç©å®¶ç‹¼ç‹ä¸”æ˜¯è‡ªå·±
            else if (player.id === gameState.peer.id) {
                // æ˜¾ç¤ºèƒ½åŠ›ä½¿ç”¨ç•Œé¢
                showAbilityArea('ç‹¼ç‹æŠ€èƒ½', 'é€‰æ‹©ä¸€åç©å®¶å¸¦èµ°ï¼š', 'wolf_king_howl');
            } 
            // å¦‚æœæ˜¯å…¶ä»–ç©å®¶ç‹¼ç‹
            else {
                // ç­‰å¾…ç‹¼ç‹é€‰æ‹©
                broadcastGameLog('ç­‰å¾…ç‹¼ç‹é€‰æ‹©ä¸€åç©å®¶å¸¦èµ°...');
            }
        }

        // å¤„ç†çŒäººèƒ½åŠ›
        function processHunterAbility(player) {
            // æ ‡è®°çŒäººæ­»äº¡
            gameState.hunterDead = true;
            
            // å¹¿æ’­çŒäººèº«ä»½
            broadcastGameLog(`${player.name} æ˜¯çŒäººï¼æ­»å‰ä»–å¯ä»¥å¼€æªå¸¦èµ°ä¸€åç©å®¶...`);
            
            // å¦‚æœæ˜¯AIçŒäºº
            if (player.isAI) {
                // AIåšå‡ºå†³ç­–
                const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === player.id);
                if (aiIndex !== -1) {
                    const aiPlayer = gameState.aiPlayers[aiIndex];
                    const targetId = aiMakeDecision(aiPlayer, 'hunter_shoot');
                    
                    if (targetId) {
                        const targetPlayer = gameState.players.find(p => p.id === targetId);
                        if (targetPlayer) {
                            // å¹¿æ’­çŒäººå¼€æªä¿¡æ¯
                            broadcastGameLog(`çŒäºº ${player.name} å¼€æªæ‰“ä¸­äº† ${targetPlayer.name}ï¼`);
                            
                            // æ ‡è®°ç›®æ ‡ç©å®¶æ­»äº¡
                            markPlayerDead(targetId, 'hunter');
                        }
                    }
                }
            } 
            // å¦‚æœæ˜¯ç©å®¶çŒäººä¸”æ˜¯è‡ªå·±
            else if (player.id === gameState.peer.id) {
                // æ˜¾ç¤ºèƒ½åŠ›ä½¿ç”¨ç•Œé¢
                showAbilityArea('çŒäººæŠ€èƒ½', 'é€‰æ‹©ä¸€åç©å®¶å°„æ€ï¼š', 'hunter_shoot');
            } 
            // å¦‚æœæ˜¯å…¶ä»–ç©å®¶çŒäºº
            else {
                // ç­‰å¾…çŒäººé€‰æ‹©
                broadcastGameLog('ç­‰å¾…çŒäººé€‰æ‹©ä¸€åç©å®¶å°„æ€...');
            }
        }

        // æ˜¾ç¤ºèƒ½åŠ›ä½¿ç”¨åŒºåŸŸ
        function showAbilityArea(title, instruction, abilityType) {
            const abilityArea = document.getElementById('ability-area');
            const abilityTitle = document.getElementById('ability-title');
            const abilityInstruction = document.getElementById('ability-instruction');
            const abilityOptions = document.getElementById('ability-options');
            
            // è®¾ç½®æ ‡é¢˜å’Œè¯´æ˜
            abilityTitle.textContent = title;
            abilityInstruction.textContent = instruction;
            
            // æ¸…ç©ºé€‰é¡¹
            abilityOptions.innerHTML = '';
            
            // è·å–æ‰€æœ‰æ´»ç€çš„ç©å®¶ä½œä¸ºç›®æ ‡
            const alivePlayers = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id) && player.id !== gameState.peer.id
            );
            
            // å¦‚æœæ˜¯å¥³å·«ä½¿ç”¨æ¯’è¯ï¼ŒåŒ…æ‹¬è‡ªå·±
            if (abilityType === 'witch_poison') {
                const selfPlayer = gameState.players.find(p => p.id === gameState.peer.id);
                if (selfPlayer && !gameState.deadPlayers.includes(selfPlayer.id)) {
                    alivePlayers.push(selfPlayer);
                }
            }
            
            // æ·»åŠ ç©å®¶é€‰é¡¹
            alivePlayers.forEach(player => {
                const option = document.createElement('div');
                option.className = 'p-3 border rounded-lg bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 cursor-pointer hover:border-primary dark:hover:border-primary transition';
                option.setAttribute('data-player-id', player.id);
                
                option.innerHTML = `
                    <div class="text-center mb-1">
                        <span class="inline-block h-8 w-8 rounded-full ${player.isAI ? 'bg-green-500' : 'bg-primary'} text-white flex items-center justify-center mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </span>
                    </div>
                    <div class="text-center">
                        <p class="font-medium truncate">${player.name}${player.id === gameState.peer.id ? ' (ä½ )' : ''}</p>
                    </div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                option.addEventListener('click', () => {
                    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                    document.querySelectorAll('#ability-options > div').forEach(el => {
                        el.classList.remove('border-primary', 'dark:border-primary');
                        el.classList.add('border-gray-200', 'dark:border-gray-700');
                    });
                    
                    // æ ‡è®°å½“å‰é€‰æ‹©
                    option.classList.remove('border-gray-200', 'dark:border-gray-700');
                    option.classList.add('border-primary', 'dark:border-primary');
                    
                    // ä¿å­˜é€‰æ‹©
                    gameState.selectedAbilityTarget = player.id;
                });
                
                abilityOptions.appendChild(option);
            });
            
            // è®¾ç½®ç¡®è®¤æŒ‰é’®äº‹ä»¶
            const confirmBtn = document.getElementById('confirm-ability-btn');
            confirmBtn.onclick = () => {
                if (!gameState.selectedAbilityTarget) {
                    alert('è¯·é€‰æ‹©ä¸€åç©å®¶');
                    return;
                }
                
                // ä½¿ç”¨èƒ½åŠ›
                useAbility(abilityType, gameState.selectedAbilityTarget);
                
                // éšè—èƒ½åŠ›åŒºåŸŸ
                abilityArea.classList.add('hidden');
            };
            
            // è®¾ç½®è·³è¿‡æŒ‰é’®äº‹ä»¶
            const skipBtn = document.getElementById('skip-ability-btn');
            skipBtn.onclick = () => {
                // è·³è¿‡ä½¿ç”¨èƒ½åŠ›
                useAbility(abilityType, null);
                
                // éšè—èƒ½åŠ›åŒºåŸŸ
                abilityArea.classList.add('hidden');
            };
            
            // æ˜¾ç¤ºèƒ½åŠ›åŒºåŸŸ
            abilityArea.classList.remove('hidden');
        }

        // ä½¿ç”¨èƒ½åŠ›
        function useAbility(abilityType, targetId) {
            switch (abilityType) {
                case 'wolf_kill':
                    // ç‹¼äººæ€äºº
                    if (gameState.isHost) {
                        gameState.wolfVotes[gameState.peer.id] = targetId;
                        checkAllWolvesVoted();
                    } else {
                        // å‘é€ç»™æˆ¿ä¸»
                        const hostId = gameState.players.find(p => p.isHost)?.id;
                        if (hostId && gameState.connections[hostId]) {
                            gameState.connections[hostId].send({
                                type: 'game_action',
                                action: 'wolf_kill',
                                data: {
                                    wolfId: gameState.peer.id,
                                    targetId: targetId
                                }
                            });
                        }
                    }
                    
                    // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                    document.getElementById('night-message').textContent = targetId ? 'ä½ é€‰æ‹©äº†çŒæ€ç›®æ ‡ï¼Œè¯·ç­‰å¾…å…¶ä»–ç‹¼äººå†³å®š...' : 'ä½ é€‰æ‹©è·³è¿‡æœ¬è½®æ€äºº';
                    break;
                
                case 'witch_save':
                    // å¥³å·«æ•‘äºº
                    if (gameState.isHost) {
                        gameState.witchSaveTarget = targetId;
                        
                        if (targetId) {
                            gameState.savedByWitch = true;
                            addToGameLog('ä½ ä½¿ç”¨è§£è¯æ•‘äº†è¢«ç‹¼äººè¢­å‡»çš„äºº');
                        } else {
                            addToGameLog('ä½ é€‰æ‹©ä¸ä½¿ç”¨è§£è¯');
                        }
                        
                        // æ ‡è®°è§£è¯å·²ä½¿ç”¨
                        gameState.witchSaveUsed = targetId !== null;
                        
                        // å¦‚æœå¥³å·«æ˜¯æˆ¿ä¸»ï¼Œç»§ç»­å¥³å·«çš„ç¬¬äºŒä¸ªé€‰æ‹©ï¼ˆæ¯’è¯ï¼‰
                        processWitchPoisonPhase();
                    } else {
                        // å‘é€ç»™æˆ¿ä¸»
                        const hostId = gameState.players.find(p => p.isHost)?.id;
                        if (hostId && gameState.connections[hostId]) {
                            gameState.connections[hostId].send({
                                type: 'game_action',
                                action: 'witch_save',
                                data: {
                                    witchId: gameState.peer.id,
                                    save: targetId !== null
                                }
                            });
                        }
                    }
                    
                    // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                    document.getElementById('night-message').textContent = targetId !== null ? 'ä½ ä½¿ç”¨äº†è§£è¯' : 'ä½ é€‰æ‹©ä¸ä½¿ç”¨è§£è¯';
                    break;
                
                case 'witch_poison':
                    // å¥³å·«æ¯’äºº
                    if (gameState.isHost) {
                        gameState.witchPoisonTarget = targetId;
                        
                        if (targetId) {
                            const targetPlayer = gameState.players.find(p => p.id === targetId);
                            addToGameLog(`ä½ ä½¿ç”¨æ¯’è¯æ¯’æ­»äº† ${targetPlayer ? targetPlayer.name : 'æŸäºº'}`);
                        } else {
                            addToGameLog('ä½ é€‰æ‹©ä¸ä½¿ç”¨æ¯’è¯');
                        }
                        
                        // æ ‡è®°æ¯’è¯å·²ä½¿ç”¨
                        gameState.witchPoisonUsed = targetId !== null;
                        
                        // ç»§ç»­å¤„ç†å¤œæ™šé˜¶æ®µ
                        processNextNightRole();
                    } else {
                        // å‘é€ç»™æˆ¿ä¸»
                        const hostId = gameState.players.find(p => p.isHost)?.id;
                        if (hostId && gameState.connections[hostId]) {
                            gameState.connections[hostId].send({
                                type: 'game_action',
                                action: 'witch_poison',
                                data: {
                                    witchId: gameState.peer.id,
                                    targetId: targetId
                                }
                            });
                        }
                    }
                    
                    // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                    document.getElementById('night-message').textContent = targetId ? 'ä½ ä½¿ç”¨äº†æ¯’è¯' : 'ä½ é€‰æ‹©ä¸ä½¿ç”¨æ¯’è¯';
                    break;
                
                case 'seer_check':
                    // é¢„è¨€å®¶æŸ¥éªŒ
                    if (gameState.isHost) {
                        gameState.seerTarget = targetId;
                        
                        if (targetId) {
                            const targetPlayer = gameState.players.find(p => p.id === targetId);
                            const isWolf = ['wolf', 'wolf-king'].includes(targetPlayer?.role);
                            
                            // éšç‹¼å¯¹é¢„è¨€å®¶æŸ¥éªŒæ˜¾ç¤ºä¸ºå¥½äºº
                            const isFakeGood = targetPlayer?.role === 'secret-wolf';
                            
                            if (targetPlayer) {
                                if (isWolf && !isFakeGood) {
                                    addToGameLog(`ä½ æŸ¥éªŒçš„ç»“æœï¼š${targetPlayer.name} æ˜¯ç‹¼äºº`);
                                } else {
                                    addToGameLog(`ä½ æŸ¥éªŒçš„ç»“æœï¼š${targetPlayer.name} æ˜¯å¥½äºº`);
                                }
                            }
                        } else {
                            addToGameLog('ä½ é€‰æ‹©è·³è¿‡æŸ¥éªŒ');
                        }
                        
                        // ç»§ç»­å¤„ç†å¤œæ™šé˜¶æ®µ
                        processNextNightRole();
                    } else {
                        // å‘é€ç»™æˆ¿ä¸»
                        const hostId = gameState.players.find(p => p.isHost)?.id;
                        if (hostId && gameState.connections[hostId]) {
                            gameState.connections[hostId].send({
                                type: 'game_action',
                                action: 'seer_check',
                                data: {
                                    seerId: gameState.peer.id,
                                    targetId: targetId
                                }
                            });
                        }
                    }
                    
                    // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                    document.getElementById('night-message').textContent = targetId ? 'ä½ æ­£åœ¨æŸ¥éªŒä¸­...' : 'ä½ é€‰æ‹©è·³è¿‡æŸ¥éªŒ';
                    break;
                
                case 'guard_protect':
                    // å®ˆå«ä¿æŠ¤
                    if (gameState.isHost) {
                        // æ£€æŸ¥æ˜¯å¦è¿ç»­ä¸¤æ™šä¿æŠ¤åŒä¸€ä¸ªäºº
                        if (targetId && targetId === gameState.lastGuardTarget) {
                            alert('ä½ ä¸èƒ½è¿ç»­ä¸¤æ™šä¿æŠ¤åŒä¸€ä¸ªäºº');
                            return;
                        }
                        
                        gameState.guardTarget = targetId;
                        gameState.lastGuardTarget = targetId;
                        
                        if (targetId) {
                            const targetPlayer = gameState.players.find(p => p.id === targetId);
                            addToGameLog(`ä½ é€‰æ‹©ä¿æŠ¤ ${targetPlayer ? targetPlayer.name : 'æŸäºº'}`);
                        } else {
                            addToGameLog('ä½ é€‰æ‹©ä¸ä¿æŠ¤ä»»ä½•äºº');
                        }
                        
                        // ç»§ç»­å¤„ç†å¤œæ™šé˜¶æ®µ
                        processNextNightRole();
                    } else {
                        // å‘é€ç»™æˆ¿ä¸»
                        const hostId = gameState.players.find(p => p.isHost)?.id;
                        if (hostId && gameState.connections[hostId]) {
                            gameState.connections[hostId].send({
                                type: 'game_action',
                                action: 'guard_protect',
                                data: {
                                    guardId: gameState.peer.id,
                                    targetId: targetId,
                                    lastTarget: gameState.lastGuardTarget
                                }
                            });
                        }
                    }
                    
                    // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                    document.getElementById('night-message').textContent = targetId ? 'ä½ é€‰æ‹©äº†å®ˆæŠ¤ç›®æ ‡' : 'ä½ é€‰æ‹©ä¸å®ˆæŠ¤ä»»ä½•äºº';
                    break;
                
                case 'wolf_king_howl':
                    // ç‹¼ç‹å¸¦èµ°æŠ€èƒ½
                    if (targetId) {
                        const targetPlayer = gameState.players.find(p => p.id === targetId);
                        
                        // å‘é€ç»™æˆ¿ä¸»
                        if (!gameState.isHost) {
                            const hostId = gameState.players.find(p => p.isHost)?.id;
                            if (hostId && gameState.connections[hostId]) {
                                gameState.connections[hostId].send({
                                    type: 'game_action',
                                    action: 'wolf_king_howl',
                                    data: {
                                        wolfKingId: gameState.peer.id,
                                        targetId: targetId
                                    }
                                });
                            }
                        } else {
                            // å¦‚æœæˆ¿ä¸»æ˜¯ç‹¼ç‹
                            broadcastGameLog(`ç‹¼ç‹ ${gameState.playerName} åšå«ç€å¸¦èµ°äº† ${targetPlayer ? targetPlayer.name : 'æŸäºº'}ï¼`);
                            markPlayerDead(targetId, 'wolf_king');
                        }
                    } else {
                        // å‘é€è·³è¿‡
                        if (!gameState.isHost) {
                            const hostId = gameState.players.find(p => p.isHost)?.id;
                            if (hostId && gameState.connections[hostId]) {
                                gameState.connections[hostId].send({
                                    type: 'game_action',
                                    action: 'wolf_king_howl',
                                    data: {
                                        wolfKingId: gameState.peer.id,
                                        targetId: null
                                    }
                                });
                            }
                        } else {
                            // æˆ¿ä¸»ç‹¼ç‹è·³è¿‡
                            broadcastGameLog(`ç‹¼ç‹ ${gameState.playerName} æ”¾å¼ƒäº†å¸¦èµ°ä»»ä½•äºº`);
                        }
                    }
                    break;
                
                case 'hunter_shoot':
                    // çŒäººå°„æ€æŠ€èƒ½
                    if (targetId) {
                        const targetPlayer = gameState.players.find(p => p.id === targetId);
                        
                        // å‘é€ç»™æˆ¿ä¸»
                        if (!gameState.isHost) {
                            const hostId = gameState.players.find(p => p.isHost)?.id;
                            if (hostId && gameState.connections[hostId]) {
                                gameState.connections[hostId].send({
                                    type: 'game_action',
                                    action: 'hunter_shoot',
                                    data: {
                                        hunterId: gameState.peer.id,
                                        targetId: targetId
                                    }
                                });
                            }
                        } else {
                            // å¦‚æœæˆ¿ä¸»æ˜¯çŒäºº
                            broadcastGameLog(`çŒäºº ${gameState.playerName} å¼€æªæ‰“ä¸­äº† ${targetPlayer ? targetPlayer.name : 'æŸäºº'}ï¼`);
                            markPlayerDead(targetId, 'hunter');
                        }
                    } else {
                        // å‘é€è·³è¿‡
                        if (!gameState.isHost) {
                            const hostId = gameState.players.find(p => p.isHost)?.id;
                            if (hostId && gameState.connections[hostId]) {
                                gameState.connections[hostId].send({
                                    type: 'game_action',
                                    action: 'hunter_shoot',
                                    data: {
                                        hunterId: gameState.peer.id,
                                        targetId: null
                                    }
                                });
                            }
                        } else {
                            // æˆ¿ä¸»çŒäººè·³è¿‡
                            broadcastGameLog(`çŒäºº ${gameState.playerName} æ”¾å¼ƒäº†å¼€æª`);
                        }
                    }
                    break;
            }
        }

        // å‘ç‹¼äººæ˜¾ç¤ºå¯ç”¨çš„è¢­å‡»ç›®æ ‡
        function showWolfKillOptions() {
            // è·å–æ‰€æœ‰æ´»ç€çš„éç‹¼äººç©å®¶
            const targets = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id) && 
                !['wolf', 'wolf-king', 'secret-wolf'].includes(player.role)
            );
            
            // æ˜¾ç¤ºèƒ½åŠ›ä½¿ç”¨ç•Œé¢
            showAbilityArea('ç‹¼äººæ€äºº', 'é€‰æ‹©ä¸€åç©å®¶è¢­å‡»ï¼š', 'wolf_kill');
            
            // æ›´æ–°å¤œæ™šæ¶ˆæ¯
            document.getElementById('night-message').textContent = 'ç‹¼äººè¯·ççœ¼ï¼Œé€‰æ‹©ä½ è¦è¢­å‡»çš„ç›®æ ‡';
        }

        // å¥³å·«è·å–è¢«ç‹¼äººè¢­å‡»çš„ä¿¡æ¯
        function notifyWitchOfWolfTarget(witchId) {
            const witch = gameState.players.find(p => p.id === witchId);
            
            // å¦‚æœå¥³å·«æ²¡æœ‰è§£è¯ï¼Œè·³è¿‡æ•‘äººç¯èŠ‚
            if (gameState.witchSaveUsed) {
                // å¦‚æœæ˜¯AIå¥³å·«ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥
                if (witch.isAI) {
                    if (gameState.isHost) {
                        processWitchPoisonPhase();
                    }
                } else {
                    // å‘ŠçŸ¥ç©å®¶å¥³å·«è§£è¯å·²ç”¨å®Œ
                    sendPrivateInfo(witchId, 'game_action', {
                        action: 'witch_info',
                        data: {
                            message: 'ä½ çš„è§£è¯å·²ç»ç”¨å®Œäº†',
                            phase: 'poison'
                        }
                    });
                }
                return;
            }
            
            // è·å–ç‹¼äººè¢­å‡»ç›®æ ‡
            const targetPlayer = gameState.players.find(p => p.id === gameState.killedAtNight);
            
            // å¦‚æœæ˜¯AIå¥³å·«
            if (witch.isAI) {
                // è®°å½•åœ¨AIç©å®¶çŠ¶æ€ä¸­
                const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === witchId);
                if (aiIndex !== -1) {
                    gameState.aiPlayers[aiIndex].witchSaveUsed = false;
                    gameState.aiPlayers[aiIndex].witchPoisonUsed = false;
                    
                    // AIå†³ç­–æ˜¯å¦æ•‘äºº
                    const saveDecision = aiMakeDecision(gameState.aiPlayers[aiIndex], 'witch_save');
                    gameState.savedByWitch = saveDecision;
                    gameState.witchSaveUsed = saveDecision;
                    gameState.aiPlayers[aiIndex].witchSaveUsed = saveDecision;
                    
                    // ç»§ç»­å¤„ç†å¥³å·«æ¯’äºº
                    if (gameState.isHost) {
                        processWitchPoisonPhase();
                    }
                }
            } else {
                // å‘é€ç»™ç©å®¶å¥³å·«
                sendPrivateInfo(witchId, 'game_action', {
                    action: 'witch_info',
                    data: {
                        killedPlayer: targetPlayer ? targetPlayer.name : null,
                        killedPlayerId: gameState.killedAtNight,
                        phase: 'save'
                    }
                });
            }
        }

        // å¥³å·«å†³å®šæ˜¯å¦ä½¿ç”¨æ¯’è¯
        function processWitchPoisonPhase() {
            // è·å–å¥³å·«
            const witch = gameState.players.find(p => p.role === 'witch' && !gameState.deadPlayers.includes(p.id));
            
            // å¦‚æœæ²¡æœ‰å¥³å·«æˆ–æ¯’è¯å·²ç”¨å®Œï¼Œè·³è¿‡
            if (!witch || gameState.witchPoisonUsed) {
                processNextNightRole();
                return;
            }
            
            // å¦‚æœæ˜¯AIå¥³å·«
            if (witch.isAI) {
                // AIå†³ç­–æ˜¯å¦ä½¿ç”¨æ¯’è¯
                const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === witch.id);
                if (aiIndex !== -1) {
                    const poisonTarget = aiMakeDecision(gameState.aiPlayers[aiIndex], 'witch_poison');
                    gameState.witchPoisonTarget = poisonTarget;
                    gameState.witchPoisonUsed = poisonTarget !== null;
                    gameState.aiPlayers[aiIndex].witchPoisonUsed = poisonTarget !== null;
                    
                    // ç»§ç»­å¤„ç†å¤œæ™šé˜¶æ®µ
                    processNextNightRole();
                }
            } else if (witch.id === gameState.peer.id) {
                // æ˜¯ç©å®¶è‡ªå·±
                showAbilityArea('å¥³å·«æ¯’è¯', 'é€‰æ‹©ä¸€åç©å®¶æ¯’æ­»ï¼š', 'witch_poison');
                
                // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                document.getElementById('night-message').textContent = 'ä½ å¯ä»¥ä½¿ç”¨æ¯’è¯...';
            } else {
                // é€šçŸ¥ç©å®¶å¥³å·«
                sendPrivateInfo(witch.id, 'game_action', {
                    action: 'witch_info',
                    data: {
                        phase: 'poison'
                    }
                });
            }
        }

        // é¢„è¨€å®¶æŸ¥éªŒ
        function processSeerCheck() {
            // è·å–é¢„è¨€å®¶
            const seer = gameState.players.find(p => p.role === 'seer' && !gameState.deadPlayers.includes(p.id));
            
            // å¦‚æœæ²¡æœ‰é¢„è¨€å®¶ï¼Œè·³è¿‡
            if (!seer) {
                processNextNightRole();
                return;
            }
            
            // å¦‚æœæ˜¯AIé¢„è¨€å®¶
            if (seer.isAI) {
                // AIå†³ç­–æŸ¥éªŒç›®æ ‡
                const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === seer.id);
                if (aiIndex !== -1) {
                    const checkTarget = aiMakeDecision(gameState.aiPlayers[aiIndex], 'seer_check');
                    gameState.seerTarget = checkTarget;
                    
                    if (checkTarget) {
                        // ä¿å­˜æŸ¥éªŒç»“æœ
                        const targetPlayer = gameState.players.find(p => p.id === checkTarget);
                        if (targetPlayer) {
                            // åˆ¤æ–­æ˜¯å¦ä¸ºç‹¼ï¼ˆéšç‹¼æ˜¾ç¤ºä¸ºå¥½äººï¼‰
                            const isWolf = ['wolf', 'wolf-king'].includes(targetPlayer.role);
                            const isFakeGood = targetPlayer.role === 'secret-wolf';
                            
                            if (!gameState.aiPlayers[aiIndex].seerResults) {
                                gameState.aiPlayers[aiIndex].seerResults = [];
                            }
                            
                            gameState.aiPlayers[aiIndex].seerResults.push({
                                playerName: targetPlayer.name,
                                playerId: targetPlayer.id,
                                isWolf: isWolf && !isFakeGood
                            });
                            
                            // å¦‚æœæŸ¥åˆ°ç‹¼ï¼Œæ·»åŠ åˆ°æ€€ç–‘åˆ—è¡¨
                            if (isWolf && !isFakeGood) {
                                if (!gameState.aiPlayers[aiIndex].suspicions) {
                                    gameState.aiPlayers[aiIndex].suspicions = [];
                                }
                                if (!gameState.aiPlayers[aiIndex].suspicions.includes(targetPlayer.id)) {
                                    gameState.aiPlayers[aiIndex].suspicions.push(targetPlayer.id);
                                }
                            }
                        }
                    }
                    
                    // ç»§ç»­å¤„ç†å¤œæ™šé˜¶æ®µ
                    processNextNightRole();
                }
            } else if (seer.id === gameState.peer.id) {
                // æ˜¯ç©å®¶è‡ªå·±
                showAbilityArea('é¢„è¨€å®¶æŸ¥éªŒ', 'é€‰æ‹©ä¸€åç©å®¶æŸ¥éªŒï¼š', 'seer_check');
                
                // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                document.getElementById('night-message').textContent = 'é¢„è¨€å®¶è¯·ççœ¼ï¼Œä½ è¦æŸ¥éªŒè°ï¼Ÿ';
            } else {
                // é€šçŸ¥ç©å®¶é¢„è¨€å®¶
                sendPrivateInfo(seer.id, 'game_action', {
                    action: 'seer_turn'
                });
            }
        }

        // å®ˆå«ä¿æŠ¤
        function processGuardProtect() {
            // è·å–å®ˆå«
            const guard = gameState.players.find(p => p.role === 'guard' && !gameState.deadPlayers.includes(p.id));
            
            // å¦‚æœæ²¡æœ‰å®ˆå«ï¼Œè·³è¿‡
            if (!guard) {
                processNextNightRole();
                return;
            }
            
            // å¦‚æœæ˜¯AIå®ˆå«
            if (guard.isAI) {
                // AIå†³ç­–ä¿æŠ¤ç›®æ ‡
                const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === guard.id);
                if (aiIndex !== -1) {
                    // ç¡®ä¿ä¸è¿ç»­ä¸¤æ™šä¿æŠ¤åŒä¸€ä¸ªäºº
                    let protectTarget = aiMakeDecision(gameState.aiPlayers[aiIndex], 'guard_protect');
                    
                    if (protectTarget === gameState.lastGuardTarget) {
                        // éšæœºé€‰æ‹©å¦ä¸€ä¸ªç›®æ ‡
                        const otherTargets = gameState.players.filter(p => 
                            !gameState.deadPlayers.includes(p.id) && 
                            p.id !== guard.id && 
                            p.id !== gameState.lastGuardTarget
                        );
                        
                        if (otherTargets.length > 0) {
                            protectTarget = otherTargets[Math.floor(Math.random() * otherTargets.length)].id;
                        } else {
                            protectTarget = null; // æ²¡æœ‰å…¶ä»–å¯é€‰ç›®æ ‡
                        }
                    }
                    
                    gameState.guardTarget = protectTarget;
                    gameState.lastGuardTarget = protectTarget;
                    
                    // ç»§ç»­å¤„ç†å¤œæ™šé˜¶æ®µ
                    processNextNightRole();
                }
            } else if (guard.id === gameState.peer.id) {
                // æ˜¯ç©å®¶è‡ªå·±
                showAbilityArea('å®ˆå«ä¿æŠ¤', 'é€‰æ‹©ä¸€åç©å®¶ä¿æŠ¤ï¼š', 'guard_protect');
                
                // æ›´æ–°å¤œæ™šæ¶ˆæ¯
                document.getElementById('night-message').textContent = 'å®ˆå«è¯·ççœ¼ï¼Œä½ è¦ä¿æŠ¤è°ï¼Ÿ';
            } else {
                // é€šçŸ¥ç©å®¶å®ˆå«
                sendPrivateInfo(guard.id, 'game_action', {
                    action: 'guard_turn',
                    data: {
                        lastTarget: gameState.lastGuardTarget
                    }
                });
            }
        }

        // å¤œæ™šé˜¶æ®µå¤„ç†
        function processNightPhase() {
            // åˆå§‹åŒ–å¤œæ™šæ•°æ®
            gameState.wolfVotes = {};
            gameState.killedAtNight = null;
            gameState.savedByWitch = false;
            gameState.poisonedByWitch = null;
            gameState.guardTarget = null;
            
            // å¤„ç†ç‹¼äººæ€äºº
            processWolfKillPhase();
        }

        // ç‹¼äººæ€äººé˜¶æ®µ
        function processWolfKillPhase() {
            // è·å–æ‰€æœ‰æ´»ç€çš„ç‹¼äºº
            const wolves = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id) && 
                ['wolf', 'wolf-king', 'secret-wolf'].includes(player.role)
            );
            
            // å¦‚æœæ²¡æœ‰ç‹¼äººäº†ï¼Œç›´æ¥è¿›å…¥ç™½å¤©
            if (wolves.length === 0) {
                startDayPhase(gameState.day + 1);
                return;
            }
            
            // å¹¿æ’­ç‹¼äººå›åˆ
            broadcastGameLog('ç‹¼äººä»¬æ­£åœ¨é€‰æ‹©è¢­å‡»ç›®æ ‡...');
            
            // é€šçŸ¥æ‰€æœ‰æ´»ç€çš„ç‹¼äºº
            wolves.forEach(wolf => {
                if (wolf.isAI) {
                    // AIç‹¼äººå†³ç­–
                    const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === wolf.id);
                    if (aiIndex !== -1) {
                        const target = aiMakeDecision(gameState.aiPlayers[aiIndex], 'wolf_kill');
                        gameState.wolfVotes[wolf.id] = target;
                    }
                } else if (wolf.id === gameState.peer.id) {
                    // æ˜¯ç©å®¶è‡ªå·±
                    showWolfKillOptions();
                } else {
                    // å…¶ä»–ç©å®¶ç‹¼
                    sendPrivateInfo(wolf.id, 'game_action', {
                        action: 'wolf_turn'
                    });
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç‹¼äººéƒ½å·²æŠ•ç¥¨
            checkAllWolvesVoted();
        }

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç‹¼äººéƒ½å·²æŠ•ç¥¨
        function checkAllWolvesVoted() {
            // è·å–æ‰€æœ‰æ´»ç€çš„ç‹¼äºº
            const wolves = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id) && 
                ['wolf', 'wolf-king', 'secret-wolf'].includes(player.role)
            );
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç‹¼äººéƒ½å·²æŠ•ç¥¨
            const allVoted = wolves.every(wolf => gameState.wolfVotes.hasOwnProperty(wolf.id));
            
            if (allVoted) {
                // è®¡ç®—æ€äººç»“æœ
                calculateWolfKillResult();
            }
        }

        // è®¡ç®—ç‹¼äººæ€äººç»“æœ
        function calculateWolfKillResult() {
            // ç»Ÿè®¡ç¥¨æ•°
            const voteCounts = {};
            let maxVotes = 0;
            let targets = [];
            
            Object.values(gameState.wolfVotes).forEach(targetId => {
                // å¿½ç•¥å¼ƒæƒç¥¨
                if (targetId === null) return;
                
                if (!voteCounts[targetId]) {
                    voteCounts[targetId] = 0;
                }
                voteCounts[targetId]++;
                
                if (voteCounts[targetId] > maxVotes) {
                    maxVotes = voteCounts[targetId];
                    targets = [targetId];
                } else if (voteCounts[targetId] === maxVotes) {
                    targets.push(targetId);
                }
            });
            
            // å¦‚æœæœ‰ç›®æ ‡ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
            if (targets.length > 0) {
                gameState.killedAtNight = targets[Math.floor(Math.random() * targets.length)];
            }
            
            // å¤„ç†å¥³å·«æ•‘äººé˜¶æ®µ
            processWitchSavePhase();
        }

        // å¥³å·«æ•‘äººé˜¶æ®µ
        function processWitchSavePhase() {
            // è·å–å¥³å·«
            const witch = gameState.players.find(p => p.role === 'witch' && !gameState.deadPlayers.includes(p.id));
            
            // å¦‚æœæ²¡æœ‰å¥³å·«æˆ–æ²¡æœ‰äººè¢«æ€ï¼Œè·³è¿‡
            if (!witch || !gameState.killedAtNight) {
                processNextNightRole();
                return;
            }
            
            // é€šçŸ¥å¥³å·«
            notifyWitchOfWolfTarget(witch.id);
        }

        // å¤„ç†ä¸‹ä¸€ä¸ªå¤œæ™šè§’è‰²è¡ŒåŠ¨
        function processNextNightRole() {
            // åˆ¤æ–­å½“å‰é˜¶æ®µ
            if (gameState.seerTarget === undefined) {
                // é¢„è¨€å®¶è¿˜æ²¡è¡ŒåŠ¨
                processSeerCheck();
            } else if (gameState.guardTarget === undefined) {
                // å®ˆå«è¿˜æ²¡è¡ŒåŠ¨
                processGuardProtect();
            } else {
                // æ‰€æœ‰è§’è‰²éƒ½è¡ŒåŠ¨å®Œäº†ï¼Œè®¡ç®—å¤œæ™šç»“æœ
                calculateNightResult();
            }
        }

        // è®¡ç®—å¤œæ™šç»“æœ
        function calculateNightResult() {
            let nightDeaths = [];
            
            // å¤„ç†ç‹¼äººæ€äºº
            if (gameState.killedAtNight) {
                // æ£€æŸ¥æ˜¯å¦è¢«å¥³å·«æ•‘äº†
                if (gameState.savedByWitch) {
                    // è¢«å¥³å·«æ•‘äº†ï¼Œä¸æ­»
                } 
                // æ£€æŸ¥æ˜¯å¦è¢«å®ˆå«ä¿æŠ¤äº†
                else if (gameState.guardTarget === gameState.killedAtNight) {
                    // è¢«å®ˆå«ä¿æŠ¤äº†ï¼Œä¸æ­»
                } 
                else {
                    // è¢«ç‹¼äººæ€æ­»
                    nightDeaths.push({
                        playerId: gameState.killedAtNight,
                        reason: 'wolf'
                    });
                }
            }
            
            // å¤„ç†å¥³å·«æ¯’äºº
            if (gameState.witchPoisonTarget) {
                nightDeaths.push({
                    playerId: gameState.witchPoisonTarget,
                    reason: 'witch'
                });
            }
            
            // è¿›å…¥ç™½å¤©
            if (gameState.isHost) {
                // å…ˆå¤„ç†æ­»äº¡
                nightDeaths.forEach(death => {
                    markPlayerDead(death.playerId, death.reason);
                });
                
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (!checkGameEnd()) {
                    // è¿›å…¥ç™½å¤©
                    setTimeout(() => {
                        // å¹¿æ’­ç™½å¤©å¼€å§‹
                        Object.values(gameState.connections).forEach(conn => {
                            conn.send({
                                type: 'game_action',
                                action: 'next_phase',
                                data: {
                                    phase: 'day_discussion',
                                    day: gameState.day + 1
                                }
                            });
                        });
                        
                        // æœ¬åœ°ä¹Ÿè¿›å…¥ç™½å¤©
                        startDayPhase(gameState.day + 1);
                    }, 3000);
                }
            }
        }

        // æ ‡è®°ç©å®¶æ­»äº¡
        function markPlayerDead(playerId, reason) {
            if (!playerId || gameState.deadPlayers.includes(playerId)) return;
            
            // æ·»åŠ åˆ°æ­»äº¡åˆ—è¡¨
            gameState.deadPlayers.push(playerId);
            
            // è·å–ç©å®¶ä¿¡æ¯
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            
            // åˆ¤æ–­æ­»äº¡åŸå› å¯¹åº”çš„æè¿°
            let deathMessage = '';
            switch (reason) {
                case 'wolf':
                    deathMessage = `${player.name} è¢«ç‹¼äººæ€æ­»äº†`;
                    break;
                case 'witch':
                    deathMessage = `${player.name} è¢«å¥³å·«æ¯’æ­»äº†`;
                    break;
                case 'voted':
                    deathMessage = `${player.name} è¢«æ‘æ°‘æŠ•ç¥¨æ”¾é€äº†`;
                    break;
                case 'hunter':
                    deathMessage = `${player.name} è¢«çŒäººå°„æ€äº†`;
                    break;
                case 'wolf_king':
                    deathMessage = `${player.name} è¢«ç‹¼ç‹å¸¦èµ°äº†`;
                    break;
                default:
                    deathMessage = `${player.name} æ­»äº¡äº†`;
            }
            
            // å¹¿æ’­æ­»äº¡æ¶ˆæ¯
            broadcastGameLog(deathMessage);
            
            // ç‰¹æ®Šæƒ…å†µï¼šç™½ç—´è¢«æŠ•ç¥¨
            if (player.role === 'idiot' && reason === 'voted') {
                // ç™½ç—´è¢«æŠ•ç¥¨åä»å¯ä»¥å‘è¨€ä½†ä¸èƒ½æŠ•ç¥¨
                gameState.deadPlayers = gameState.deadPlayers.filter(id => id !== playerId);
                gameState.spectators.push(playerId);
                
                broadcastGameLog(`${player.name} æ˜¯ç™½ç—´ï¼Œè¢«æ”¾é€åä»å¯ä»¥å‘è¨€ï¼Œä½†å¤±å»äº†æŠ•ç¥¨æƒ`);
            }
            
            // æ›´æ–°ç©å®¶çŠ¶æ€
            updatePlayerStatusGrid();
            
            // å¦‚æœæ˜¯çŒäººæ­»äº¡
            if (player.role === 'hunter' && !gameState.hunterDead &&
                (reason === 'wolf' || reason === 'witch')) {
                gameState.hunterDead = true;
                broadcastGameLog(`${player.name} æ˜¯çŒäººï¼æ­»å‰ä»–å¯ä»¥å¼€æªå¸¦èµ°ä¸€åç©å®¶...`);
                
                // å¦‚æœæ˜¯AIçŒäºº
                if (player.isAI) {
                    const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === player.id);
                    if (aiIndex !== -1) {
                        const aiPlayer = gameState.aiPlayers[aiIndex];
                        const targetId = aiMakeDecision(aiPlayer, 'hunter_shoot');
                        
                        if (targetId) {
                            const targetPlayer = gameState.players.find(p => p.id === targetId);
                            if (targetPlayer) {
                                broadcastGameLog(`çŒäºº ${player.name} å¼€æªæ‰“ä¸­äº† ${targetPlayer.name}ï¼`);
                                markPlayerDead(targetId, 'hunter');
                            }
                        } else {
                            broadcastGameLog(`çŒäºº ${player.name} æ”¾å¼ƒäº†å¼€æª`);
                        }
                    }
                } 
                // å¦‚æœæ˜¯ç©å®¶çŒäºº
                else if (player.id === gameState.peer.id) {
                    showAbilityArea('çŒäººæŠ€èƒ½', 'é€‰æ‹©ä¸€åç©å®¶å°„æ€ï¼š', 'hunter_shoot');
                } 
                // å¦‚æœæ˜¯å…¶ä»–ç©å®¶çŒäºº
                else {
                    sendPrivateInfo(player.id, 'game_action', {
                        action: 'hunter_turn'
                    });
                }
            }
            
            // å¦‚æœæ˜¯ç‹¼ç‹æ­»äº¡
            if (player.role === 'wolf-king' && !gameState.wolfKingDead &&
                (reason === 'wolf' || reason === 'witch')) {
                gameState.wolfKingDead = true;
                broadcastGameLog(`${player.name} æ˜¯ç‹¼ç‹ï¼æ­»å‰ä»–å¯ä»¥å¸¦èµ°ä¸€åç©å®¶...`);
                
                // å¦‚æœæ˜¯AIç‹¼ç‹
                if (player.isAI) {
                    const aiIndex = gameState.aiPlayers.findIndex(ai => ai.id === player.id);
                    if (aiIndex !== -1) {
                        const aiPlayer = gameState.aiPlayers[aiIndex];
                        const targetId = aiMakeDecision(aiPlayer, 'wolf_king_howl');
                        
                        if (targetId) {
                            const targetPlayer = gameState.players.find(p => p.id === targetId);
                            if (targetPlayer) {
                                broadcastGameLog(`ç‹¼ç‹ ${player.name} åšå«ç€å¸¦èµ°äº† ${targetPlayer.name}ï¼`);
                                markPlayerDead(targetId, 'wolf_king');
                            }
                        } else {
                            broadcastGameLog(`ç‹¼ç‹ ${player.name} æ”¾å¼ƒäº†å¸¦èµ°ä»»ä½•äºº`);
                        }
                    }
                } 
                // å¦‚æœæ˜¯ç©å®¶ç‹¼ç‹
                else if (player.id === gameState.peer.id) {
                    showAbilityArea('ç‹¼ç‹æŠ€èƒ½', 'é€‰æ‹©ä¸€åç©å®¶å¸¦èµ°ï¼š', 'wolf_king_howl');
                } 
                // å¦‚æœæ˜¯å…¶ä»–ç©å®¶ç‹¼ç‹
                else {
                    sendPrivateInfo(player.id, 'game_action', {
                        action: 'wolf_king_turn'
                    });
                }
            }
            
            // æ›´æ–°äººæ•°ç»Ÿè®¡
            updateTeamCounts();
        }

        // æ›´æ–°é˜µè¥äººæ•°ç»Ÿè®¡
        function updateTeamCounts() {
            // è®¡ç®—æ´»ç€çš„å¥½äººæ•°é‡
            gameState.villagerCount = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id) && 
                !['wolf', 'wolf-king', 'secret-wolf'].includes(player.role)
            ).length;
            
            // è®¡ç®—æ´»ç€çš„ç‹¼äººæ•°é‡
            gameState.wolfCount = gameState.players.filter(player => 
                !gameState.deadPlayers.includes(player.id) && 
                ['wolf', 'wolf-king', 'secret-wolf'].includes(player.role)
            ).length;
        }

        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        function checkGameEnd() {
            // æ›´æ–°äººæ•°ç»Ÿè®¡
            updateTeamCounts();
            
            // åˆ¤æ–­èƒœåˆ©æ¡ä»¶
            if (gameState.wolfCount === 0) {
                // å¥½äººèƒœåˆ©
                endGame('good');
                return true;
            } else if (gameState.wolfCount >= gameState.villagerCount) {
                // ç‹¼äººèƒœåˆ©
                endGame('wolf');
                return true;
            }
            
            return false;
        }

        // ç»“æŸæ¸¸æˆ
        function endGame(winner) {
            gameState.gamePhase = 'game_over';
            gameState.winningTeam = winner;
            
            // æ˜¾ç¤ºç»“æœå¼¹çª—
            showResultModal(winner);
            
            // æ›´æ–°æ¸¸æˆé˜¶æ®µæ˜¾ç¤º
            updateGamePhaseUI();
            
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œå¹¿æ’­æ¸¸æˆç»“æŸ
            if (gameState.isHost) {
                // è·å–æ‰€æœ‰ç©å®¶çš„è§’è‰²ä¿¡æ¯
                const roles = gameState.players.map(player => ({
                    id: player.id,
                    name: player.name,
                    role: player.role
                }));
                
                // å¹¿æ’­æ¸¸æˆç»“æŸ
                Object.values(gameState.connections).forEach(conn => {
                    conn.send({
                        type: 'game_action',
                        action: 'game_over',
                        data: {
                            winner: winner,
                            roles: roles
                        }
                    });
                });
            }
        }

        // æ˜¾ç¤ºç»“æœå¼¹çª—
        function showResultModal(winner) {
            const title = document.getElementById('result-title');
            const content = document.getElementById('result-content');
            
            // è®¾ç½®æ ‡é¢˜
            if (winner === 'good') {
                title.textContent = 'å¥½äººé˜µè¥èƒœåˆ©ï¼';
                title.className = 'text-2xl font-bold mb-4 text-villager';
            } else {
                title.textContent = 'ç‹¼äººé˜µè¥èƒœåˆ©ï¼';
                title.className = 'text-2xl font-bold mb-4 text-wolf';
            }
            
            // ç”Ÿæˆç©å®¶è§’è‰²åˆ—è¡¨
            let rolesHtml = '<div class="mb-4">ç©å®¶è§’è‰²ï¼š</div>';
            rolesHtml += '<div class="grid grid-cols-1 md:grid-cols-2 gap-2">';
            
            gameState.players.forEach(player => {
                const isAlive = !gameState.deadPlayers.includes(player.id);
                const roleName = ROLE_NAMES[player.role] || 'æœªçŸ¥';
                const roleIcon = ROLE_ICONS[player.role] || 'â“';
                
                rolesHtml += `
                    <div class="flex items-center ${isAlive ? '' : 'text-gray-500 dark:text-gray-400'}">
                        <span class="inline-block w-6 text-center">${roleIcon}</span>
                        <span class="font-medium ml-2">${player.name}</span>
                        <span class="ml-auto">${roleName}</span>
                    </div>
                `;
            });
            
            rolesHtml += '</div>';
            content.innerHTML = rolesHtml;
            
            // æ˜¾ç¤ºå¼¹çª—
            showModal('result-modal');
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(playerName, text, playerId = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'mb-2';
            
            const isYou = playerId === gameState.peer.id;
            const isDead = gameState.deadPlayers.includes(playerId);
            
            // æ·»åŠ åå­—å’Œæ¶ˆæ¯å†…å®¹
            messageElement.innerHTML = `
                <div class="flex items-start">
                    <span class="font-medium ${isDead ? 'text-gray-500 dark:text-gray-400' : ''}">${playerName}${isYou ? ' (ä½ )' : ''}:</span>
                    <span class="ml-1 break-words ${isDead ? 'text-gray-500 dark:text-gray-400' : ''}">${text}</span>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘è¨€
            if (gameState.gamePhase === 'night') {
                alert('å¤œæ™šæ— æ³•å‘è¨€');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ´»ç€
            if (gameState.deadPlayers.includes(gameState.peer.id) && !gameState.spectators.includes(gameState.peer.id)) {
                alert('ä½ å·²ç»æ­»äº¡ï¼Œæ— æ³•å‘è¨€');
                return;
            }
            
            // æ£€æŸ¥å‘è¨€è½®æ¬¡
            if (gameState.gamePhase === 'speaking' && gameState.currentSpeaker !== gameState.peer.id) {
                alert('ç°åœ¨ä¸æ˜¯ä½ çš„å‘è¨€è½®æ¬¡');
                return;
            }
            
            // æ·»åŠ åˆ°æœ¬åœ°èŠå¤©
            addChatMessage(gameState.playerName, text, gameState.peer.id);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // å¹¿æ’­èŠå¤©æ¶ˆæ¯
            broadcastChatMessage(gameState.peer.id, gameState.playerName, text);
        }

        // å¹¿æ’­èŠå¤©æ¶ˆæ¯ç»™æ‰€æœ‰ç©å®¶
        function broadcastChatMessage(playerId, playerName, text) {
            Object.values(gameState.connections).forEach(conn => {
                conn.send({
                    type: 'chat_message',
                    playerName: playerName,
                    playerId: playerId,
                    text: text
                });
            });
        }

        // æ·»åŠ æ¸¸æˆæ—¥å¿—
        function addToGameLog(text, type = 'normal') {
            const logContainer = document.getElementById('game-log');
            const logElement = document.createElement('p');
            
            switch (type) {
                case 'highlight':
                    logElement.className = 'text-primary dark:text-primary';
                    break;
                case 'warning':
                    logElement.className = 'text-orange-600 dark:text-orange-400';
                    break;
                case 'error':
                    logElement.className = 'text-red-600 dark:text-red-400';
                    break;
                case 'success':
                    logElement.className = 'text-green-600 dark:text-green-400';
                    break;
                default:
                    logElement.className = '';
            }
            
            logElement.textContent = text;
            logContainer.appendChild(logElement);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // å¹¿æ’­æ¸¸æˆæ—¥å¿—ç»™æ‰€æœ‰ç©å®¶
        function broadcastGameLog(text) {
            Object.values(gameState.connections).forEach(conn => {
                conn.send({
                    type: 'game_log',
                    text: text
                });
            });
            
            // åŒæ—¶æ·»åŠ åˆ°æœ¬åœ°æ—¥å¿—
            addToGameLog(text);
        }

        // é€€å‡ºæˆ¿é—´
        function leaveRoom() {
            // å…³é—­æ‰€æœ‰è¿æ¥
            Object.values(gameState.connections).forEach(conn => {
                conn.close();
            });
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.connections = {};
            gameState.players = [];
            gameState.aiPlayers = [];
            gameState.roomCode = null;
            gameState.isHost = false;
            gameState.gameStarted = false;
            gameState.gamePhase = 'waiting';
            gameState.day = 0;
            gameState.deadPlayers = [];
            gameState.inited = false;
            
            // è¿”å›æ¬¢è¿å±å¹•
            showScreen('welcome-screen');
        }

        // é€€å‡ºæ¸¸æˆ
        function quitGame() {
            // ç¡®è®¤æ˜¯å¦è¦é€€å‡º
            if (!confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ')) {
                return;
            }
            
            hideModal('menu-modal');
            leaveRoom();
        }

        // è¿”å›ä¸»èœå•
        function backToMainMenu() {
            hideModal('result-modal');
            leaveRoom();
        }

        // å¤åˆ¶æˆ¿é—´ä»£ç 
        function copyRoomCode() {
            const roomCode = document.getElementById('display-room-code').textContent;
            
            navigator.clipboard.writeText(roomCode).then(() => {
                alert('æˆ¿é—´ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // æç¤ºæ‰‹åŠ¨å¤åˆ¶
                alert('è¯·æ‰‹åŠ¨å¤åˆ¶æˆ¿é—´ä»£ç : ' + roomCode);
            });
        }

        // æ˜¾ç¤º/éšè—è§’è‰²å¡ç‰‡
        function toggleRoleCard() {
            const roleCard = document.getElementById('player-role-card');
            roleCard.classList.toggle('flipped');
            
            const description = document.getElementById('role-description');
            const viewBtn = document.getElementById('view-role-btn');
            
            if (roleCard.classList.contains('flipped')) {
                viewBtn.textContent = 'éšè—è§’è‰²';
                description.classList.remove('hidden');
            } else {
                viewBtn.textContent = 'æŸ¥çœ‹è§’è‰²';
                description.classList.add('hidden');
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–Peerè¿æ¥
            try {
                await initPeer();
                console.log('P2Påˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('P2Påˆå§‹åŒ–å¤±è´¥:', error);
                alert('è¿æ¥é”™è¯¯: ' + error.message);
            }
            
            // è§’è‰²é…ç½®å˜æ›´ç›‘å¬
            document.querySelectorAll('#role-wolf, #role-wolf-king, #role-secret-wolf, #role-villager, #role-witch, #role-hunter, #role-guard, #role-seer, #role-idiot').forEach(input => {
                input.addEventListener('change', updateRoleCountWarning);
            });
            
            // ç©å®¶äººæ•°å˜æ›´ç›‘å¬
            document.getElementById('player-count').addEventListener('change', updateRoleCountWarning);
            
            // æ¨èé…ç½®æŒ‰é’®
            document.getElementById('recommended-setup-btn').addEventListener('click', applyRecommendedSetup);
            
            // åˆ›å»ºæˆ¿é—´æŒ‰é’®
            document.getElementById('create-room-btn').addEventListener('click', createRoom);
            
            // åŠ å…¥æˆ¿é—´æŒ‰é’®
            document.getElementById('join-room-btn').addEventListener('click', joinRoom);
            
            // è¿”å›æŒ‰é’®
            document.getElementById('back-to-welcome-btn').addEventListener('click', () => showScreen('welcome-screen'));
            document.getElementById('leave-room-btn').addEventListener('click', leaveRoom);
            
            // å¤åˆ¶æˆ¿é—´ä»£ç æŒ‰é’®
            document.getElementById('copy-code-btn').addEventListener('click', copyRoomCode);
            
            // å¼€å§‹æ¸¸æˆæŒ‰é’®
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            
            // æ·»åŠ AIç©å®¶æŒ‰é’®
            document.getElementById('add-ai-btn').addEventListener('click', showAddAIModal);
            document.getElementById('confirm-add-ai-btn').addEventListener('click', addAIPlayer);
            document.getElementById('cancel-add-ai-btn').addEventListener('click', () => hideModal('add-ai-modal'));
            
            // æ¸¸æˆèœå•æŒ‰é’®
            document.getElementById('game-menu-btn').addEventListener('click', () => showModal('menu-modal'));
            document.getElementById('resume-game-btn').addEventListener('click', () => hideModal('menu-modal'));
            document.getElementById('quit-game-btn').addEventListener('click', quitGame);
            
            // ç»§ç»­æ¸¸æˆ/æ–°æ¸¸æˆæŒ‰é’®
            document.getElementById('new-game-btn').addEventListener('click', backToMainMenu);
            
            // è§’è‰²å¡ç‰‡æŒ‰é’®
            document.getElementById('view-role-btn').addEventListener('click', toggleRoleCard);
            
            // èŠå¤©å‘é€æŒ‰é’®
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', event => {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // ä¸‹ä¸€ä½å‘è¨€æŒ‰é’®
            document.getElementById('next-speaker-btn').addEventListener('click', () => {
                if (gameState.isHost || gameState.currentSpeaker === gameState.peer.id) {
                    // å¦‚æœæ˜¯æˆ¿ä¸»æˆ–å½“å‰å‘è¨€äºº
                    if (gameState.isHost) {
                        endCurrentSpeech();
                    } else {
                        // å‘é€ç»™æˆ¿ä¸»ï¼Œç»“æŸè‡ªå·±çš„å‘è¨€
                        const hostId = gameState.players.find(p => p.isHost)?.id;
                        if (hostId && gameState.connections[hostId]) {
                            gameState.connections[hostId].send({
                                type: 'game_action',
                                action: 'end_speech',
                                data: {
                                    speakerId: gameState.peer.id
                                }
                            });
                        }
                    }
                }
            });
            
            // æŠ•ç¥¨æŒ‰é’®
            document.getElementById('confirm-vote-btn').addEventListener('click', submitVote);
            document.getElementById('skip-vote-btn').addEventListener('click', skipVote);
        });
    </script>
</body>
</html>
